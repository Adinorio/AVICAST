{% extends "admindashboard/base.html" %}
{% load static %}

{% block content %}
<div class="main-content-container">
  <!-- Top Navigation Tabs -->
  <div class="tab-navigation">
    <button class="tab-button active" data-tab="upload">Upload</button>
    <button class="tab-button" data-tab="process-data">Process Data</button>
    <button class="tab-button" data-tab="review">Review</button>
  </div>

  <!-- Main Content Area -->
  <div id="upload-content" class="content-panel active-tab-content">
    <h2 class="panel-title">
      <i class="fas fa-cloud-upload-alt icon-left"></i> IMAGE UPLOAD & PROCESSING
    </h2>
    
    <!-- Model Info and Error Display -->
    <div class="model-info-error-display">
    <strong>Model in use:</strong>
    <span id="currentModel">Chinese Egret</span>
      <select id="modelSelect" class="model-select">
      <option value="chinese_egret">Chinese Egret</option>
      <option value="whiskered_tern">Whiskered Tern</option>
      <option value="great_knot">Great Knot</option>
    </select>
    {% if model_load_error %}
        <div class="error-message">
        <strong>Error:</strong> {{ model_load_error }}
      </div>
    {% endif %}
  </div>

    <!-- File Validation Rules -->
    <div class="validation-rules">
      <h3>Upload Requirements:</h3>
      <ul>
        <li><i class="fas fa-check"></i> Supported formats: JPG, PNG, JPEG</li>
        <li><i class="fas fa-check"></i> Maximum file size: 10MB</li>
        <li><i class="fas fa-check"></i> Minimum resolution: 800x600</li>
        <li><i class="fas fa-check"></i> Maximum batch size: 50 images</li>
      </ul>
  </div>
  
    <!-- Image Upload & Drop Zone -->
    <div class="drop-zone-container" id="drop-area">
      <div class="upload-icon">
        <i class="fas fa-cloud-upload-alt"></i>
      </div>
      <p class="drop-zone-text">Drag & drop images or folders here</p>
      <p class="drop-zone-or">or</p>
      <div class="button-group">
        <label for="fileElem" class="action-button primary-button">Select Files</label>
        <input type="file" id="fileElem" accept="image/jpeg,image/png,image/jpg" multiple style="display: none;">
        <label for="folderElem" class="action-button secondary-button">Select Folder</label>
        <input type="file" id="folderElem" webkitdirectory mozdirectory msdirectory odirectory directory style="display: none;">
      </div>
  </div>
  
    <!-- Selected Files Display Area -->
    <div id="selected-files-display" class="selected-files-container">
      <p id="no-files-selected-message" class="no-files-selected-message">No files selected yet.</p>
      <!-- Selected files will be displayed here dynamically -->
  </div>
  
    <!-- Upload Progress -->
    <div id="upload-progress" class="upload-progress-container" style="display: none;">
      <div class="progress-header">
        <h3>Upload Progress</h3>
        <span id="upload-status">Preparing files...</span>
    </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="upload-progress-bar"></div>
        <span id="upload-percentage">0%</span>
      </div>
      <div class="file-progress-list" id="file-progress-list">
        <!-- Individual file progress will be shown here -->
    </div>
  </div>
  
    <!-- Action Buttons at the Bottom -->
    <div class="bottom-action-buttons">
      <button id="uploadBtn" class="action-button primary-button" disabled data-state="upload">Upload</button>
      <button id="clearBtn" class="action-button secondary-button" disabled>Clear All</button>
  </div>
</div>

  <div id="process-data-content" class="content-panel" style="display: none;">
    <h2 class="panel-title">
      <i class="fas fa-cogs icon-left"></i> NEXT STEPS: REVIEW & PROCESS YOUR IMAGES
    </h2>
    <!-- Model Info and Error Display -->
    <div class="model-info-error-display disabled-model-display" style="margin-bottom: 16px; padding: 10px; background: #2f3338; border: 1px solid #4a69bd; border-radius: 6px; color: #e0e0e0;">
      <strong>Model in use:</strong>
      <span id="currentModelProcessData">Chinese Egret</span>
      {% if model_load_error %}
        <div class="error-message" style="margin-top: 10px; padding: 8px; background: #4a3838; border: 1px solid #cc4e4e; border-radius: 4px; color: #ff9e9e;">
          <strong>Error:</strong> {{ model_load_error }}
        </div>
      {% endif %}
    </div>
    <p class="upload-summary">You uploaded <span id="uploadedImageCount">0</span> images. All are ready for processing.</p>

    <div class="batch-progress-container">
      <span class="progress-label">Batch Progress:</span>
      <div class="progress-bar-background">
        <div class="progress-bar-fill" id="batchProgressBar" style="width: 0%;"></div>
      </div>
      <span class="progress-count" id="batchProgressCount">0/0</span>
    </div>

    <!-- New container for filters and process button -->
    <div class="process-data-controls">
    <div class="filter-tabs">
      <button class="filter-tab-button active" data-filter="all">All</button>
      <button class="filter-tab-button" data-filter="processing">Processing</button>
      <button class="filter-tab-button" data-filter="completed">Completed</button>
      <button class="filter-tab-button" data-filter="error">Error</button>
      </div>
      <button id="processAllImagesExplicitBtn" class="action-button primary-button">Process All Images</button>
    </div>

    <!-- Add Process All Images button above the gallery in Process Data tab -->
    <!-- (REMOVED) Original process all button container -->
    <!-- <div class="process-all-btn-container" style="text-align:center; margin-bottom: 18px;">
      <button id="processAllImagesExplicitBtn" class="action-button primary-button" style="min-width:200px;">Generate/Process All Images</button>
    </div> -->
    <div id="gallery-card" class="gallery-card" style="margin-bottom: 24px; display: none;">
      <div class="gallery-controls" id="gallery-controls" style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 10px;">
        <button id="gallery-prev" class="gallery-nav-btn" style="display: none;">&#8592; Prev</button>
        <span id="gallery-counter" class="gallery-counter"></span>
        <button id="gallery-next" class="gallery-nav-btn" style="display: none;">Next &#8594;</button>
      </div>
      <div id="gallery" style="display: flex; justify-content: center; align-items: center;"></div>
    </div>
    <div id="result-box" style="margin-bottom: 24px;"></div> <!-- Added margin-bottom here -->

    <div class="image-processing-table-container" style="margin-top: 24px;"> <!-- Added margin-top here -->
      <table class="image-processing-table">
        <thead>
          <tr>
            <th>Thumbnail</th>
            <th>Filename</th>
            <th>Status</th>
            <th>AI Results</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="imageTableBody">
          <!-- Image rows will be dynamically inserted here -->
        </tbody>
      </table>
    </div>

    <!-- (REMOVED) Original bottom action buttons container with Process All Images -->
    <!-- <div class="bottom-action-buttons">
        <button id="retryAllFailedBtn" class="action-button primary-button" style="display: none;">Retry All Failed</button>
        <button id="processAllImagesBtn" class="action-button primary-button">Process All Images</button>
    </div> -->
  </div>

  <div id="review-content" class="content-panel" style="display: none;">
    <h2 class="panel-title">
      <i class="fas fa-check-circle icon-left"></i> REVIEW DASHBOARD
    </h2>
    <p class="review-instructions">Review and approve or reject processed images below.</p>

    <!-- Modernized Review Controls and Table Styles -->
    <div class="review-controls-container">
      <div class="filter-tabs">
        <button class="filter-tab-button active" data-filter="all">All</button>
        <button class="filter-tab-button" data-filter="approved">Approved</button>
        <button class="filter-tab-button" data-filter="rejected">Rejected</button>
        <button class="filter-tab-button" data-filter="pending">Pending</button>
        <button class="filter-tab-button" data-filter="error">Error</button>
        <input type="text" id="reviewSearchInput" placeholder="Search filename...">
      </div>
    </div>
    <!-- Batch Actions Card (hidden by default) -->
    <div id="batchActionsCard" class="batch-actions-card" style="display:none;">
      <div class="batch-actions-label">Batch Actions</div>
      <div class="review-batch-group">
        <button id="approveSelectedBtn" class="action-button small-button" disabled>Approve Selected</button>
        <button id="rejectSelectedBtn" class="action-button small-button" disabled>Reject Selected</button>
        <button id="overrideSelectedBtn" class="action-button small-button" disabled>Override Selected</button>
      </div>
    </div>

    <div class="review-table-container">
      <table class="review-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllReview"></th>
            <th>Thumbnail</th>
            <th>Filename</th>
            <th>Status</th>
            <th>AI Results</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reviewTableBody">
          <!-- Review rows will be dynamically inserted here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal for full image preview -->
<div id="modal" class="modal">
  <span id="modalClose" class="modal-close">&times;</span>
  <div class="modal-content">
    <!-- The enlarged image will be inserted here -->
    <img id="modalImage" src="" alt="Full Image Preview">
  </div>
</div>

<script>
// DOM element references - Use let instead of const for elements that might need reassignment
let dropArea = document.getElementById('drop-area');
let fileInput = document.getElementById('fileElem');
let folderInput = document.getElementById('folderElem');
let gallery = document.getElementById('gallery');
let resultBox = document.getElementById('result-box');
let modelSelect = document.getElementById('modelSelect');
let currentModelSpan = document.getElementById('currentModel');
let currentModelProcessDataSpan = document.getElementById('currentModelProcessData');
let selectedFilesDisplay = document.getElementById('selected-files-display');
let noFilesSelectedMessage = document.getElementById('no-files-selected-message');
let uploadBtn = document.getElementById('uploadBtn');
let clearBtn = document.getElementById('clearBtn');
let filterTabButtons = document.querySelectorAll('.filter-tab-button');
let tabButtons = document.querySelectorAll('.tab-button');
let uploadContent = document.getElementById('upload-content');
let processDataContent = document.getElementById('process-data-content');
let reviewContent = document.getElementById('review-content');
let imageTableBody = document.getElementById('imageTableBody');
let reviewTableBody = document.getElementById('reviewTableBody');
let batchProgressBar = document.getElementById('batchProgressBar');
let batchProgressCount = document.getElementById('batchProgressCount');
let uploadedImageCount = document.getElementById('uploadedImageCount');
let retryAllFailedBtn = document.getElementById('retryAllFailedBtn');
let processAllImagesBtn = document.getElementById('processAllImagesExplicitBtn'); // Corrected ID

// Initialize arrays
let selectedFiles = [];
let imageProcessingStatus = [];
let currentImage = null;
let currentImageDataUrl = null;
let currentProcessedImage = null; // Initialize currentProcessedImage
let currentProcessedImageDataUrl = null; // Initialize currentProcessedImageDataUrl

// Add error handling for missing elements
function ensureElement(element, fallbackId) {
  if (!element) {
    console.warn(`Element ${fallbackId} not found, creating fallback`);
    const fallback = document.createElement('div');
    fallback.id = fallbackId;
    document.body.appendChild(fallback);
    return fallback;
  }
  return element;
}

// Initialize elements with fallbacks
function initializeElements() {
  // Initialize required elements
  gallery = ensureElement(gallery, 'gallery');
  resultBox = ensureElement(resultBox, 'result-box');
  selectedFilesDisplay = ensureElement(selectedFilesDisplay, 'selected-files-display');
  noFilesSelectedMessage = ensureElement(noFilesSelectedMessage, 'no-files-selected-message');
  currentModelProcessDataSpan = ensureElement(currentModelProcessDataSpan, 'currentModelProcessData');

  // Initialize tab-related elements
  filterTabButtons = document.querySelectorAll('.filter-tab-button');
  tabButtons = document.querySelectorAll('.tab-button');
  uploadContent = ensureElement(uploadContent, 'upload-content');
  processDataContent = ensureElement(processDataContent, 'process-data-content');
  reviewContent = ensureElement(reviewContent, 'review-content');
  
  // Initialize table and progress elements
  imageTableBody = ensureElement(imageTableBody, 'imageTableBody');
  reviewTableBody = ensureElement(reviewTableBody, 'reviewTableBody');
  batchProgressBar = ensureElement(batchProgressBar, 'batchProgressBar');
  batchProgressCount = ensureElement(batchProgressCount, 'batchProgressCount');
  uploadedImageCount = ensureElement(uploadedImageCount, 'uploadedImageCount');
  retryAllFailedBtn = ensureElement(retryAllFailedBtn, 'retryAllFailedBtn');
  processAllImagesBtn = ensureElement(processAllImagesBtn, 'processAllImagesExplicitBtn'); // Corrected ID
  
  // Set initial states
  if (noFilesSelectedMessage) {
    noFilesSelectedMessage.style.display = 'block';
  }
  if (retryAllFailedBtn) {
    retryAllFailedBtn.style.display = 'none';
  }
  if (processAllImagesBtn) {
    processAllImagesBtn.disabled = true;
  }
}

// Call initialization
initializeElements();

// Add error handling for image loading
function handleImageError(img) {
  img.onerror = function() {
    console.warn('Failed to load image:', img.src);
    // Replace with a default/placeholder image
    img.src = '{% static "admindashboard/images/placeholder.png" %}';
    img.alt = 'Image failed to load';
    img.classList.add('image-load-error');
  };
}

// Modify handleFiles function to ensure no large preview is shown during upload
async function handleFiles(files) {
  try {
    console.log('handleFiles called with:', files);
    if (gallery) { // Robustly clear gallery
      while (gallery.firstChild) {
        gallery.removeChild(gallery.firstChild);
      }
    }
    if (resultBox) resultBox.innerHTML = '';
    if (selectedFilesDisplay) {
      selectedFilesDisplay.innerHTML = '';
    }
    
    if (!files || files.length === 0) {
      if (noFilesSelectedMessage) {
        noFilesSelectedMessage.style.display = 'block';
      }
      return;
    }
    if (files.length > 50) {
      alert('Maximum batch size is 50 images. Please select fewer files.');
      return;
    }
    if (noFilesSelectedMessage) {
      noFilesSelectedMessage.style.display = 'none';
    }

    // Check for duplicate files
    const duplicateFiles = [];
    for (const file of files) {
      if (file.type.startsWith('image/')) {
        // Check if file with same name and size already exists
        const isDuplicate = selectedFiles.some(existingFile => 
          existingFile.name === file.name && 
          existingFile.size === file.size
        );
        
        if (isDuplicate) {
          duplicateFiles.push(file.name);
          continue;
        }

        try {
          await validateFile(file);
          selectedFiles.push(file);
          const fileEntry = {
            file: file,
            status: 'Ready',
            results: null,
            error: null,
            progress: 0,
            approved: false,
            rejected: false,
            overridden: false,
            overriddenCount: null,
            originalResults: null,
            editingOverride: false
          };
          imageProcessingStatus.push(fileEntry);
          if (selectedFilesDisplay) {
            const fileItem = document.createElement('div');
            fileItem.classList.add('selected-file-item');
            fileItem.dataset.index = imageProcessingStatus.indexOf(fileEntry);
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function() {
              fileEntry.dataUrl = reader.result;
              const img = document.createElement('img');
              img.src = reader.result;
              img.classList.add('selected-file-thumbnail');
              handleImageError(img);
              fileItem.appendChild(img);
            };
            const fileNameSpan = document.createElement('span');
            fileNameSpan.textContent = file.name;
            fileNameSpan.classList.add('selected-file-name');
            fileItem.appendChild(fileNameSpan);
            const fileSizeSpan = document.createElement('span');
            fileSizeSpan.textContent = formatFileSize(file.size);
            fileSizeSpan.classList.add('selected-file-size');
            fileItem.appendChild(fileSizeSpan);
            const removeButton = document.createElement('button');
            removeButton.innerHTML = '<i class="fas fa-times"></i>';
            removeButton.classList.add('remove-file-button');
            removeButton.addEventListener('click', (e) => {
              const indexToRemove = parseInt(e.currentTarget.closest('.selected-file-item').dataset.index);
              removeSelectedFile(indexToRemove);
            });
            fileItem.appendChild(removeButton);
            selectedFilesDisplay.appendChild(fileItem);
          }
        } catch (error) {
          console.error(`Validation failed for ${file.name}:`, error);
          if (selectedFilesDisplay) {
            const errorItem = document.createElement('div');
            errorItem.classList.add('selected-file-item', 'error');
            errorItem.innerHTML = `
              <i class="fas fa-exclamation-circle"></i>
              <span class="selected-file-name">${file.name}</span>
              <span class="error-message">${error}</span>
              <button class="remove-file-button"><i class="fas fa-times"></i></button>
            `;
            selectedFilesDisplay.appendChild(errorItem);
          }
        }
      }
    }

    // Show warning if there were duplicate files
    if (duplicateFiles.length > 0) {
      const duplicateMessage = duplicateFiles.length === 1 
        ? `The file "${duplicateFiles[0]}" was skipped because it's already in the list.`
        : `The following files were skipped because they're already in the list:\n${duplicateFiles.join('\n')}`;
      alert(duplicateMessage);
    }

    updateUploadButtonState();
  } catch (error) {
    console.error('Error in handleFiles:', error);
    alert('An error occurred while processing files. Please try again.');
  }
}

// Add error handling to file input event listeners
if (fileInput) {
  fileInput.addEventListener('change', (e) => {
    try {
      handleFiles(e.target.files);
    } catch (error) {
      console.error('Error in file input change handler:', error);
      alert('An error occurred while selecting files. Please try again.');
    }
  });
}

if (folderInput) {
  folderInput.addEventListener('change', (e) => {
    try {
      handleFiles(e.target.files);
    } catch (error) {
      console.error('Error in folder input change handler:', error);
      alert('An error occurred while selecting folder. Please try again.');
    }
  });
}

// Add error handling to drag and drop events
if (dropArea) {
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, (e) => {
      try {
        preventDefaults(e);
      } catch (error) {
        console.error(`Error in ${eventName} handler:`, error);
      }
    }, false);
  });

  dropArea.addEventListener('drop', (e) => {
    try {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    } catch (error) {
      console.error('Error in drop handler:', error);
      alert('An error occurred while dropping files. Please try again.');
    }
  }, false);
}

// Model selection change handler
modelSelect.addEventListener('change', function() {
  currentModelSpan.textContent = this.options[this.selectedIndex].text;
  // Clear previous results when model changes, but not necessarily table
  resultBox.innerHTML = '';
  // if (currentImage) { enableIdentify(); }
});

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
  document.body.addEventListener(eventName, preventDefaults, false);
});
function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

// Highlight drop area when file is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
});
['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
});

// Add new file validation functions
function validateFile(file) {
  const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
  const maxSize = 10 * 1024 * 1024; // 10MB
  const minWidth = 800;
  const minHeight = 600;

  return new Promise((resolve, reject) => {
    if (!validTypes.includes(file.type)) {
      reject(`Invalid file type: ${file.type}. Supported types are: JPG, PNG, JPEG`);
      return;
    }

    if (file.size > maxSize) {
      reject(`File too large: ${(file.size / 1024 / 1024).toFixed(2)}MB. Maximum size is 10MB`);
      return;
    }

    const img = new Image();
    img.onload = function() {
      if (img.width < minWidth || img.height < minHeight) {
        reject(`Image resolution too low: ${img.width}x${img.height}. Minimum is 800x600`);
        return;
      }
      resolve(true);
    };
    img.onerror = () => reject('Failed to load image for validation');
    img.src = URL.createObjectURL(file);
  });
}

// Add helper function to format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Modify upload button event to include progress tracking
uploadBtn.addEventListener('click', async function() {
  // Only proceed if button is in 'upload' state, meaning a new upload is intended
  if (this.dataset.state === 'upload') { // This check is important
    if (selectedFiles.length === 0) {
      resultBox.innerHTML = `<p style='color:red;'>Please select files to upload.</p>`;
      return;
    }

    // Show progress container
    document.getElementById('upload-progress').style.display = 'block';
    uploadBtn.disabled = true; // Disable during upload
    clearBtn.disabled = true; // Disable during upload

    const totalFiles = selectedFiles.length;
    let completedFiles = 0;

    // Initialize progress tracking UI elements
    const progressBar = document.getElementById('upload-progress-bar');
    const progressPercentage = document.getElementById('upload-percentage');
    const uploadStatus = document.getElementById('upload-status');
    const fileProgressList = document.getElementById('file-progress-list');
    fileProgressList.innerHTML = ''; // Clear previous file progress list

    // Populate individual file progress items
    selectedFiles.forEach((file, index) => {
      const progressItem = document.createElement('div');
      progressItem.classList.add('file-progress-item');
      progressItem.innerHTML = `
        <span class="file-name">${file.name}</span>
        <div class="file-progress-bar">
          <div class="file-progress-fill" data-index="${index}"></div>
        </div>
        <span class="file-progress-text" data-index="${index}">0%</span>
      `;
      fileProgressList.appendChild(progressItem);
    });

    // Simulate upload progress for each file
    for (let i = 0; i < totalFiles; i++) {
      const file = selectedFiles[i];
      uploadStatus.textContent = `Uploading ${i + 1} of ${totalFiles}: ${file.name}`;
      for (let progress = 0; progress <= 100; progress += 10) {
        await new Promise(resolve => setTimeout(resolve, 60)); // Simulate delay
        updateFileProgress(i, progress);
        updateOverallProgress();
      }
      completedFiles++;
    }

    uploadStatus.textContent = `Completed: ${completedFiles} of ${totalFiles} files uploaded`;

    // After upload simulation is complete:
    uploadBtn.textContent = 'Save'; // Change button text
    uploadBtn.dataset.state = 'save'; // Update button state
    uploadBtn.disabled = false; // Re-enable the Save button
  }
  // If data-state is 'save', clicking again will trigger the tab switch
  else if (this.dataset.state === 'save') {
    showTab('process-data');
    updateProcessDataView();
  }
});

// Add function to update individual file progress
function updateFileProgress(index, progress, isError = false) {
  const progressFill = document.querySelector(`.file-progress-fill[data-index="${index}"]`);
  const progressText = document.querySelector(`.file-progress-text[data-index="${index}"]`);
  
  if (progressFill && progressText) {
    progressFill.style.width = `${progress}%`;
    progressText.textContent = `${progress}%`;
    
    if (isError) {
      progressFill.classList.add('error');
      progressText.textContent = 'Error';
    }
  }
}

// Add function to update overall progress
function updateOverallProgress() {
  const progressBars = document.querySelectorAll('.file-progress-fill');
  const totalProgress = Array.from(progressBars).reduce((sum, bar) => {
    const width = parseInt(bar.style.width) || 0;
    return sum + width;
  }, 0);
  
  const averageProgress = totalProgress / progressBars.length;
  const progressBar = document.getElementById('upload-progress-bar');
  const progressPercentage = document.getElementById('upload-percentage');
  
  progressBar.style.width = `${averageProgress}%`;
  progressPercentage.textContent = `${Math.round(averageProgress)}%`;
}

// Add clear button functionality
document.getElementById('clearBtn').addEventListener('click', function() {
  selectedFiles = [];
  imageProcessingStatus = [];
  selectedFilesDisplay.innerHTML = '';
  noFilesSelectedMessage.style.display = 'block';
  document.getElementById('upload-progress').style.display = 'none';
  updateUploadButtonState();
});

// Add function to update upload button state
function updateUploadButtonState() {
  const uploadBtn = document.getElementById('uploadBtn');
  const clearBtn = document.getElementById('clearBtn');

  if (selectedFiles.length > 0) {
    // Check if any files have been processed
    const hasProcessedFiles = imageProcessingStatus.some(entry => entry.status === 'Completed' || entry.status === 'Processing');
    
    if (hasProcessedFiles) {
      // If files have been processed, disable the save button
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Save';
      uploadBtn.dataset.state = 'save';
    } else {
      // If no files have been processed, enable the upload button
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload';
      uploadBtn.dataset.state = 'upload';
    }
  } else {
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Upload';
    uploadBtn.dataset.state = 'upload';
  }
  clearBtn.disabled = (selectedFiles.length === 0); // Clear button state
}

// New function to remove a selected file
function removeSelectedFile(index) {
  // Remove from arrays
  selectedFiles.splice(index, 1);
  imageProcessingStatus.splice(index, 1);

  // Re-render the selected files display
  updateSelectedFilesDisplay();

  // Update upload button state
  if (selectedFiles.length > 0) {
    uploadBtn.disabled = false;
  } else {
    uploadBtn.disabled = true;
  }

  // Update process data view if needed (e.g., if files were removed from processing queue)
  updateProcessDataView();
  console.log(`File at index ${index} removed.`); // DEBUG
}

// New function to update the selected files display after changes (e.g., removal)
function updateSelectedFilesDisplay() {
  selectedFilesDisplay.innerHTML = ''; // Clear current display
  if (selectedFiles.length === 0) {
    noFilesSelectedMessage.style.display = 'block';
  } else {
    noFilesSelectedMessage.style.display = 'none';
    selectedFiles.forEach((file, index) => {
      const fileEntry = imageProcessingStatus.find(entry => entry.file === file); // Find corresponding entry
      if (!fileEntry) return; // Should not happen

      const fileItem = document.createElement('div');
      fileItem.classList.add('selected-file-item');
      fileItem.dataset.index = index; // Use new index after splice

      const img = document.createElement('img');
      img.src = fileEntry.dataUrl; // Use stored data URL
      img.classList.add('selected-file-thumbnail');
      fileItem.appendChild(img);

      const fileNameSpan = document.createElement('span');
      fileNameSpan.textContent = file.name;
      fileNameSpan.classList.add('selected-file-name');
      fileItem.appendChild(fileNameSpan);

      const removeButton = document.createElement('button');
      removeButton.innerHTML = '<i class="fas fa-times"></i>';
      removeButton.classList.add('remove-file-button');
      removeButton.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.closest('.selected-file-item').dataset.index);
        removeSelectedFile(indexToRemove);
      });
      fileItem.appendChild(removeButton);

      selectedFilesDisplay.appendChild(fileItem);
    });
  }
}

// Modify previewFile to not populate gallery in upload tab
function previewFile(file) {
  // This function will now only be called for the initial single preview in the upload tab if needed,
  // but primarily, the gallery in the process tab will use displayImageForProcessing.
  // For the upload tab, handleFiles populates the selected-files-display instead.
  // We can keep it to generate the dataUrl for the first file, which is then stored in imageProcessingStatus.
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onloadend = function() {
    currentImageDataUrl = reader.result;  // save the data URL for future use
    // No longer appending to 'gallery' in the upload tab here.
  }
}

// Add overlay/message for unprocessed images and auto-process on preview
function displayImageForProcessing(fileEntry) {
  currentProcessedImage = fileEntry.file;
  currentProcessedImageDataUrl = null; // Clear previous data URL
  currentGalleryIndex = imageProcessingStatus.indexOf(fileEntry);

  // Remove any previous overlay (but don't remove the node, just hide it)
  let overlay = document.getElementById('gallery-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'gallery-overlay';
    overlay.className = 'gallery-overlay';
    overlay.innerHTML = `<span class='gallery-overlay-text'><span class='spinner'></span> Not processed yet. Processing now...</span>`;
    galleryCard.style.position = 'relative';
    galleryCard.appendChild(overlay);
  }
  overlay.style.opacity = '0';
  overlay.style.visibility = 'hidden';

  // Fade in effect for canvas
  gallery.innerHTML = '';
  // resultBox.innerHTML = ''; // Do NOT clear details/results box

  const reader = new FileReader();
  reader.readAsDataURL(fileEntry.file);
  reader.onloadend = function() {
    currentProcessedImageDataUrl = reader.result;
    const img = new Image();
    img.src = currentProcessedImageDataUrl;
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.id = 'processingCanvas';
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.style.maxWidth = '100%';
      canvas.style.display = 'block';
      canvas.style.margin = '0 auto 10px';
      canvas.style.borderRadius = '10px';
      canvas.style.boxShadow = '0 2px 12px rgba(0,0,0,0.25)';
      canvas.style.opacity = '0';
      canvas.style.transition = 'opacity 0.3s';
      setTimeout(() => { canvas.style.opacity = '1'; }, 10);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      // Draw detections if available
      if (fileEntry.status === 'Completed' && fileEntry.results && fileEntry.results.length > 0) {
        fileEntry.results.forEach(det => {
          let [x1, y1, x2, y2] = det.coordinates;
          ctx.lineWidth = 2;
          ctx.strokeStyle = 'red';
          ctx.font = "16px Arial";
          ctx.fillStyle = 'red';
          ctx.beginPath();
          ctx.rect(x1, y1, x2 - x1, y2 - y1);
          ctx.stroke();
          const label = `${det.class} (${(det.confidence * 100).toFixed(1)}%)`;
          ctx.fillText(label, x1, y1 > 15 ? y1 - 5 : y1 + 15);
        });
      }
      canvas.addEventListener('click', function() {
        modalImage.src = canvas.toDataURL();
        modal.style.display = 'block';
      });
      gallery.appendChild(canvas);
    };
  };

  // Overlay/message for unprocessed images
  if (fileEntry.status !== 'Completed') {
    overlay.style.opacity = '1';
    overlay.style.visibility = 'visible';
    // Automatically process the image if not already processing
    if (fileEntry.status !== 'Processing') {
      fileEntry.status = 'Processing';
      processSingleImage(currentGalleryIndex).then(() => {
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
        displayImageForProcessing(imageProcessingStatus[currentGalleryIndex]);
      });
    }
  } else {
    overlay.style.opacity = '0';
    overlay.style.visibility = 'hidden';
  }

  // Always update the details/results box for the current image
  updateProcessedImagePreview(fileEntry);

  // Highlight the active thumbnail
  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('active-thumbnail');
  });
  const activeThumbnail = document.querySelector(`.thumbnail[data-index="${imageProcessingStatus.indexOf(fileEntry)}"]`);
  if (activeThumbnail) {
    activeThumbnail.classList.add('active-thumbnail');
  }
  updateGalleryNavigation();
}

// Add or update updateProcessedImagePreview to always update the details/results box
function updateProcessedImagePreview(imageEntry) {
  if (!resultBox) return;
  if (imageEntry.status === 'Completed') {
    let detailHtml = '';
    if (imageEntry.results && imageEntry.results.length > 0) {
      const totalDetections = imageEntry.results.length;
      const sumConfidence = imageEntry.results.reduce((sum, det) => sum + det.confidence, 0);
      const avgConfidence = sumConfidence / totalDetections;
      const selectedModelName = modelSelect.options[modelSelect.selectedIndex].text;
      const scientificNames = {
        'Chinese Egret': 'Egretta eulophotes',
        'Whiskered Tern': 'Chlidonias hybrida',
        'Great Knot': 'Calidris tenuirostris'
      };
      detailHtml += `<p><strong>Total Detections:</strong> ${totalDetections}</p>`;
      detailHtml += `<p><strong>Species Type:</strong> ${selectedModelName}</p>`;
      detailHtml += `<p><strong>Scientific Name:</strong> <em>${scientificNames[selectedModelName] || 'N/A'}</em></p>`;
      detailHtml += `<p><strong>Average Confidence:</strong> ${(avgConfidence * 100).toFixed(2)}%</p>`;
      detailHtml += `<h4>Individual Detections:</h4><ul>`;
      imageEntry.results.forEach(det => {
        detailHtml += `<li>${det.class} (${(det.confidence * 100).toFixed(1)}%)</li>`;
      });
      detailHtml += `</ul>`;
    } else {
      detailHtml = `<p>No detections found for ${imageEntry.file.name}.</p>`;
    }
    resultBox.innerHTML = detailHtml;
  } else if (imageEntry.status === 'Error') {
    resultBox.innerHTML = `<p class="error-message"><strong>Error Processing:</strong> ${imageEntry.error}</p>`;
  } else {
    resultBox.innerHTML = '<p style="color:#b0b0b0;text-align:center;padding:40px 0;font-size:1.2em;">No detections found or image not yet processed. Details will appear here.</p>';
  }
}

// Add CSS for overlay, spinner, and fade-in
const galleryOverlayStyle = document.createElement('style');
galleryOverlayStyle.textContent = `
.gallery-overlay {
  display: flex;
  align-items: center;
  justify-content: center;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(30,34,44,0.55);
  color: #fff;
  font-size: 1.2em;
  font-weight: 600;
  border-radius: 16px;
  z-index: 10;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}
.gallery-overlay-text {
  padding: 16px 32px;
  background: rgba(44, 62, 80, 0.7);
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  display: flex;
  align-items: center;
  gap: 12px;
}
.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid #fff;
  border-top: 3px solid #4a69bd;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 10px;
  display: inline-block;
}
.spinner-small {
  width: 14px;
  height: 14px;
  border: 2px solid #b0b0b0;
  border-top: 2px solid #4a69bd;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 6px;
  display: inline-block;
  vertical-align: middle;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.gallery-nav-btn {
  transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
}
.gallery-nav-btn:hover:not(:disabled) {
  background: #3e58a3;
  box-shadow: 0 4px 12px rgba(74,105,189,0.18);
  transform: translateY(-2px) scale(1.04);
}
.gallery-card {
  min-height: 420px;
  transition: min-height 0.2s;
}
`;
document.head.appendChild(galleryOverlayStyle);

function enableIdentify() {
  identifyBtn.disabled = false;
  identifyBtn.classList.remove('disabled');
}
function disableIdentify() {
  identifyBtn.disabled = true;
  identifyBtn.classList.add('disabled');
}

// Close modal when clicking on the close button or outside the image
modalClose.onclick = function() {
  modal.style.display = 'none';
}
window.onclick = function(e) {
  if (e.target == modal) {
    modal.style.display = 'none';
  }
}

// Function to update the Process Data tab view
function updateProcessDataView() {
  uploadedImageCount.textContent = selectedFiles.length;
  batchProgressCount.textContent = `0/${selectedFiles.length}`;
  batchProgressBar.style.width = '0%';
  imageTableBody.innerHTML = ''; // Clear previous table content

  if (selectedFiles.length === 0) {
    imageTableBody.innerHTML = '<tr><td colspan="5">No images uploaded.</td></tr>';
    processAllImagesBtn.disabled = true;
    retryAllFailedBtn.style.display = 'none';
    if (gallery) gallery.innerHTML = '<div style="color:#b0b0b0;text-align:center;padding:40px 0;">No image to preview. Upload files first.</div>';
    if (resultBox) resultBox.innerHTML = '<div style="color:#b0b0b0;text-align:center;padding:40px 0;font-size:1.2em;">No images to process.</div>';
    return;
  }

  selectedFiles.forEach((file, index) => {
    const fileEntry = imageProcessingStatus[index];
    if (!fileEntry || !fileEntry.dataUrl) return;

    let statusText = fileEntry.status;
    let statusClass = `status-${fileEntry.status.toLowerCase()}`;
    let aiResultsText = '';
    let actionButtonHtml = `<button class="action-button small-button process-single-btn" data-index="${index}">Process</button>`;
    let actionButtonDisabled = false;

    if (fileEntry.status === 'Completed') {
      statusText = 'Completed';
      if (fileEntry.overridden) { // New: Indicate overridden status in Process Data tab
        aiResultsText = `Overridden: ${(fileEntry.overriddenCount !== null) ? fileEntry.overriddenCount : (fileEntry.originalResults ? fileEntry.originalResults.length : 0)} detections`;
        statusText += ' <i class="fas fa-pencil-alt" style="color: #ffc107; margin-left: 5px;"></i>'; // Add override icon
      } else {
        aiResultsText = `${fileEntry.results.length} detections`;
      }
      actionButtonHtml = '<button class="action-button small-button" disabled style="display:none;">Processed</button>';
    } else if (fileEntry.status === 'Processing') {
      statusText = '<span class="spinner-small"></span> Processing';
      actionButtonHtml = '<button class="action-button small-button" disabled>Processing</button>';
      actionButtonDisabled = true;
    } else if (fileEntry.status === 'Error') {
      statusText = 'Error';
      aiResultsText = 'Failed';
      actionButtonHtml = '<button class="action-button small-button process-single-btn" data-index="${index}">Retry</button>';
    }

    const row = imageTableBody.insertRow();
    row.dataset.index = index;
    row.innerHTML = `
      <td><img src="${fileEntry.dataUrl}" class="thumbnail-table" alt="${file.name}"></td>
      <td>${file.name}</td>
      <td class="status-cell ${statusClass}">${statusText}</td>
      <td>${aiResultsText}</td>
      <td>${actionButtonHtml}</td>
    `;

    // Add click listener for thumbnail to display in large preview
    row.querySelector('.thumbnail-table').addEventListener('click', () => {
      previewImageInGallery(imageProcessingStatus[index]);
    });

    // Add click listener for individual process/retry button if it exists and is not disabled
    const processSingleBtn = row.querySelector('.process-single-btn');
    if (processSingleBtn && !actionButtonDisabled) {
      processSingleBtn.addEventListener('click', async (e) => {
        const imageIndex = e.target.dataset.index;
        await displayImageForProcessing(imageProcessingStatus[imageIndex]);
      });
    }
  });
  processAllImagesBtn.disabled = false;
  updateGalleryNavigation();
  updateProcessAllBtnState();

  if (selectedFiles.length > 0) {
    const initialIndex = currentGalleryIndex !== undefined && imageProcessingStatus[currentGalleryIndex] ? currentGalleryIndex : 0;
    previewImageInGallery(imageProcessingStatus[initialIndex]);
  }
}

// Function to process a single image
async function processSingleImage(index) {
  // (REMOVED) console.log('Inside processSingleImage: currentProcessedImage =', currentProcessedImage);
  const imageEntry = imageProcessingStatus[index];
  if (!imageEntry) return;

  // Update status in table
  const row = imageTableBody.querySelector(`tr[data-index="${index}"]`);
  if (row) {
    const statusCell = row.querySelector('.status-cell');
    statusCell.innerHTML = '<span class="spinner-small"></span> Processing'; // Add spinner
    statusCell.classList.remove('status-ready', 'status-completed', 'status-error');
    statusCell.classList.add('status-processing');
    row.querySelector('td:nth-child(4)').textContent = '-'; // Clear AI Results
    row.querySelector('.process-single-btn').disabled = true; // Disable individual button
  }
  updateBatchProgress();

  const formData = new FormData();
  formData.append('image', imageEntry.file);
  formData.append('model', modelSelect.value);
  
  try {
    const response = await fetch('/admindashboard/api/process_bird_image/', {
    method: 'POST',
    body: formData,
    });
    const data = await response.json();

    if (data.error) {
      imageEntry.status = 'Error';
      imageEntry.error = data.error;
      if (row) {
        const statusCell = row.querySelector('.status-cell');
        statusCell.innerHTML = 'Error'; // Remove spinner
        statusCell.classList.remove('status-processing');
        statusCell.classList.add('status-error');
        row.querySelector('td:nth-child(4)').textContent = 'Failed';
        row.querySelector('.process-single-btn').disabled = false; // Re-enable for retry
        row.querySelector('.process-single-btn').textContent = 'Retry';
      }
    } else {
      imageEntry.status = 'Completed';
      imageEntry.results = data.detections; // Store detections
      if (row) {
        const statusCell = row.querySelector('.status-cell');
        statusCell.innerHTML = 'Completed'; // Remove spinner
        statusCell.classList.remove('status-processing');
        statusCell.classList.add('status-completed');
        row.querySelector('td:nth-child(4)').textContent = `${data.detections.length} detections`;
        row.querySelector('.process-single-btn').style.display = 'none'; // Hide button after completion
      }
    }
  } catch (error) {
    console.error(`Error processing ${imageEntry.file.name}:`, error);
    imageEntry.status = 'Error';
    imageEntry.error = error.message;
    if (row) {
      const statusCell = row.querySelector('.status-cell');
      statusCell.innerHTML = 'Error'; // Remove spinner
      statusCell.classList.remove('status-processing');
      statusCell.classList.add('status-error');
      row.querySelector('td:nth-child(4)').textContent = 'Error';
      row.querySelector('.process-single-btn').disabled = false;
      row.querySelector('.process-single-btn').textContent = 'Retry';
    }
  } finally {
    updateBatchProgress();
    checkAllProcessed();
    // Safely check if currentProcessedImage is defined before accessing its properties
    if (typeof currentProcessedImage !== 'undefined' && currentProcessedImage && currentProcessedImage.name === imageEntry.file.name) {
      updateProcessedImagePreview(imageEntry);
    }
  }
}

// Function to update batch progress
function updateBatchProgress() {
  const total = imageProcessingStatus.length;
  const completed = imageProcessingStatus.filter(item => item.status === 'Completed').length;
  const processing = imageProcessingStatus.filter(item => item.status === 'Processing').length;
  const error = imageProcessingStatus.filter(item => item.status === 'Error').length;

  batchProgressCount.textContent = `${completed}/${total}`;
  const progressPercentage = total > 0 ? (completed / total) * 100 : 0;
  batchProgressBar.style.width = `${progressPercentage}%`;

  // Show retry all failed button if there are errors
  if (error > 0) {
    retryAllFailedBtn.style.display = 'inline-block';
  } else {
    retryAllFailedBtn.style.display = 'none';
  }

  // Disable process all button if all are completed or processing
  if (completed + error === total || processing > 0) {
    processAllImagesBtn.disabled = true;
  } else {
    processAllImagesBtn.disabled = false;
  }

  // Update sub-tabs counts (optional, for later)
  document.querySelector(`.filter-tab-button[data-filter="all"]`).textContent = `All (${total})`;
  document.querySelector(`.filter-tab-button[data-filter="processing"]`).textContent = `Processing (${processing})`;
  document.querySelector(`.filter-tab-button[data-filter="completed"]`).textContent = `Completed (${completed})`;
  document.querySelector(`.filter-tab-button[data-filter="error"]`).textContent = `Error (${error})`;
}

// Function to check if all images are processed
function checkAllProcessed() {
  const total = imageProcessingStatus.length;
  const processedCount = imageProcessingStatus.filter(item => item.status === 'Completed' || item.status === 'Error').length;
  if (total > 0 && processedCount === total) {
    console.log('All images processed. You can now review the results.');
    // Potentially enable Review tab or prompt user to go to Review tab
    // (REMOVED) For now, let's automatically switch to review tab when all are processed
    // showTab('review');
    updateReviewDataView();
  }
}

// Process All Images button event
processAllImagesBtn.addEventListener('click', async function() {
  processAllImagesBtn.disabled = true;
  retryAllFailedBtn.disabled = true; // Disable retry button during batch processing

  for (let i = 0; i < imageProcessingStatus.length; i++) {
    const entry = imageProcessingStatus[i];
    // Only process if status is Ready or Error
    if (entry.status === 'Ready' || entry.status === 'Error') {
      await processSingleImage(i); // Process one by one to update UI
    }
  }
  processAllImagesBtn.disabled = false;
  updateProcessAllBtnState();

  // After batch processing, update the gallery for the first image if available
  if (imageProcessingStatus.length > 0) {
    previewImageInGallery(imageProcessingStatus[0]); // Changed to previewImageInGallery
  }
});

// Retry All Failed button event
retryAllFailedBtn.addEventListener('click', async function() {
  retryAllFailedBtn.disabled = true;
  processAllImagesBtn.disabled = true; // Disable process all during retry

  for (let i = 0; i < imageProcessingStatus.length; i++) {
    const entry = imageProcessingStatus[i];
    if (entry.status === 'Error') {
      await processSingleImage(i); // Retry only failed images
    }
  }
  retryAllFailedBtn.disabled = false;
  updateBatchProgress(); // Update progress and button states
});

// Filter tab buttons event listeners
filterTabButtons.forEach(button => {
  button.addEventListener('click', function() {
    filterTabButtons.forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    const filter = this.dataset.filter;
    filterImageTable(filter);
  });
});

// Function to filter the image table
function filterImageTable(filter) {
  const rows = imageTableBody.querySelectorAll('tr');
  rows.forEach(row => {
    const statusCell = row.querySelector('.status-cell');
    const status = statusCell.textContent.toLowerCase();
    
    if (filter === 'all') {
      row.style.display = '';
    } else if (status.includes(filter)) {
      row.style.display = '';
      } else {
      row.style.display = 'none';
    }
  });
}

// Tab switching logic
function showTab(tabName) {
  // Deactivate all tab buttons and hide all tab contents
  tabButtons.forEach(button => {
    button.classList.remove('active');
  });
  [uploadContent, processDataContent, reviewContent].forEach(content => {
    content.style.display = 'none';
  });

  // Activate the selected tab button and show its content
  const selectedTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
  const selectedTabContent = document.getElementById(`${tabName}-content`);

  if (selectedTabButton && selectedTabContent) {
    selectedTabButton.classList.add('active');
    selectedTabContent.style.display = 'block';
    if (tabName === 'review') {
      updateReviewDataView(); // Update review tab content when shown
    } else if (tabName === 'process-data') { // Add this condition
      updateProcessDataView(); // Ensure process data view is updated on tab switch
    } else if (tabName === 'upload') {
      // Update upload button state when returning to upload tab
      updateUploadButtonState();
      if (gallery) gallery.innerHTML = '';
      if (resultBox) resultBox.innerHTML = '';
    }
  }
}

// Add event listeners to tab buttons
tabButtons.forEach(button => {
  button.addEventListener('click', function() {
    const tabName = this.dataset.tab;
    showTab(tabName);
  });
});

// Initial state: hide columns container (handled by tab switching now)
// columnsContainer.style.display = 'none';

// Initial setup to show the Upload tab by default
showTab('upload');

// New function to update the Review tab view
function updateReviewDataView() {
  reviewTableBody.innerHTML = '';
  const searchValue = document.getElementById('reviewSearchInput')?.value?.toLowerCase() || '';
  const activeFilterBtn = document.querySelector('.filter-tab-button.active');
  const statusFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';

  let anyRows = false;
  imageProcessingStatus.forEach((entry, index) => {
    // Review Status Logic
    let reviewStatus = 'pending';
    let buttonsEnabled = false; // General button enablement for Approve/Reject
    let overrideButtonEnabled = false; // Separate enablement for Override/Cancel button
    let rowClass = '';

    if (entry.approved) {
      reviewStatus = 'approved';
    } else if (entry.rejected) {
      reviewStatus = 'rejected';
    } else if (entry.editingOverride) { // New: If actively editing override
      reviewStatus = 'overridden-editing'; // Special status for editing
      rowClass = 'overridden-editing-row';
      buttonsEnabled = false; // Disable Approve/Reject when editing override
      overrideButtonEnabled = true; // Enable Cancel button
    } else if (entry.overridden) { // New: If already overridden (but not editing)
      reviewStatus = 'overridden';
      rowClass = 'overridden-row';
      buttonsEnabled = true; // Approve/Reject can be re-enabled after override
      overrideButtonEnabled = true; // Enable Edit button
    } else if (entry.status === 'Error') {
      reviewStatus = 'error';
    } else if (entry.status === 'Completed' && !entry.approved && !entry.rejected && !entry.overridden) {
      reviewStatus = 'pending';
      buttonsEnabled = true; // Enable buttons for pending completed images
      overrideButtonEnabled = true; // Enable Override button
    } else if (entry.status === 'Ready' || entry.status === 'Processing') {
      return; // Do not show non-processed images in review tab
    }
    
    // Filtering logic based on reviewStatus
    if (statusFilter !== 'all' && reviewStatus !== statusFilter) return;
    if (searchValue && !entry.file.name.toLowerCase().includes(searchValue)) return;
    anyRows = true;

    const row = document.createElement('tr');
    row.dataset.index = index;
    if (rowClass) {
      row.classList.add(rowClass);
    }
    let statusHtml = '';
    let aiResultsHtml = '';
    
    if (reviewStatus === 'approved') statusHtml = `<span class="status-cell status-completed"><i class="fas fa-check-circle"></i> Approved</span>`;
    else if (reviewStatus === 'rejected') statusHtml = `<span class="status-cell status-error"><i class="fas fa-times-circle"></i> Rejected</span>`;
    else if (reviewStatus === 'error') statusHtml = `<span class="status-cell status-error"><i class="fas fa-times-circle"></i> Error</span>`;
    else if (reviewStatus === 'overridden-editing') statusHtml = `<span class="status-cell status-overridden-editing"><span class="spinner-small"></span> Editing Override</span>`; // New: for active editing
    else if (reviewStatus === 'overridden') statusHtml = `<span class="status-cell status-overridden"><i class="fas fa-pencil-alt"></i> Overridden</span>`;
    else if (reviewStatus === 'pending') statusHtml = `<span class="status-cell status-ready">Pending</span>`;

    // AI Results display logic
    if (entry.editingOverride) { // New: Editable input for active override editing
      const currentCount = (entry.overriddenCount !== null) ? entry.overriddenCount : (entry.originalResults ? entry.originalResults.length : 0);
      aiResultsHtml = `<input type="number" class="override-count-input" data-index="${index}" value="${currentCount}" min="0">`;
    } else if (entry.overridden) { // New: Display overridden count when not editing
      aiResultsHtml = `Overridden: ${(entry.overriddenCount !== null) ? entry.overriddenCount : (entry.originalResults ? entry.originalResults.length : 0)} detections`;
    } else if (entry.results && entry.results.length > 0) {
      const totalDetections = entry.results.length;
      const sumConfidence = entry.results.reduce((sum, det) => sum + det.confidence, 0);
      const avgConfidence = sumConfidence / totalDetections;
      aiResultsHtml = `<a href="#" class="ai-results-link" data-index="${index}">Birds: ${totalDetections}, Confidence: ${(avgConfidence * 100).toFixed(1)}%</a>`;
    } else if (entry.status === 'Error') {
      aiResultsHtml = `Processing failed: ${entry.error || 'Unknown error'}`;
    } else {
      aiResultsHtml = 'N/A';
    }

    row.innerHTML = `
      <td><input type="checkbox" class="review-select-checkbox" data-index="${index}"></td>
      <td><img src="${entry.dataUrl || ''}" class="thumbnail-table" alt="${entry.file.name}"></td>
      <td>${entry.file.name}</td>
      <td>${statusHtml}</td>
      <td>${aiResultsHtml}</td>
      <td>
        <button class="action-button small-button approve-btn" data-index="${index}" ${(entry.approved || entry.editingOverride) ? 'disabled' : ''}>Approve</button>
        <button class="action-button small-button reject-btn" data-index="${index}" ${(entry.rejected || entry.editingOverride) ? 'disabled' : ''}>Reject</button>
        <button class="action-button small-button override-btn" data-index="${index}">
          ${entry.editingOverride ? (entry.overriddenCount === (entry.originalResults ? entry.originalResults.length : 0) ? 'Save' : 'Cancel') : (entry.overridden ? 'Edit' : 'Override')}
        </button>
      </td>
    `;
    
    // Action buttons
    const approveBtn = row.querySelector('.approve-btn');
    const rejectBtn = row.querySelector('.reject-btn');
    const overrideBtn = row.querySelector('.override-btn');
    
    if (approveBtn) {
      approveBtn.addEventListener('click', () => {
        entry.approved = true;
        entry.rejected = false;
        updateReviewDataView();
      });
    }
    if (rejectBtn) {
      rejectBtn.addEventListener('click', () => {
        entry.rejected = true;
        entry.approved = false;
        updateReviewDataView();
      });
    }
    if (overrideBtn) {
      overrideBtn.addEventListener('click', () => {
        if (entry.editingOverride) { // If currently editing
          // Check if the value is back to original
          const currentCount = entry.overriddenCount;
          const originalCount = entry.originalResults ? entry.originalResults.length : 0;
          
          if (currentCount === originalCount) {
            // If value is back to original, clear override status
            entry.editingOverride = false;
            entry.overridden = false;
            entry.overriddenCount = null;
          } else {
            // If value is different, keep override status
            entry.editingOverride = false;
            entry.overridden = true;
          }
        } else { // This is either the Override or Edit button
          entry.editingOverride = true; // Enter editing mode
          entry.overridden = true; // Mark as overridden (if not already)
          entry.approved = false; // Clear approved/rejected state
          entry.rejected = false;
          // Store original results if not already stored, and set initial overriddenCount
          if (!entry.originalResults && entry.results) {
            entry.originalResults = JSON.parse(JSON.stringify(entry.results));
            entry.overriddenCount = entry.originalResults.length; // Set initial count from AI detections
          } else if (entry.overriddenCount === null && entry.results) { // If no overrideCount yet, use results length
            entry.overriddenCount = entry.results.length;
          }
        }
        updateReviewDataView();
      });
    }

    // Add event listener for override count input
    const overrideInput = row.querySelector('.override-count-input');
    if (overrideInput) {
      overrideInput.addEventListener('change', (e) => {
        const newCount = parseInt(e.target.value);
        if (!isNaN(newCount) && newCount >= 0) {
          // Only update the temporary count, don't save it yet
          entry.overriddenCount = newCount;
        }
      });
    }

    // Add event listener for tab switching to handle unsaved changes
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        // Find any entries that are in editing mode
        const editingEntries = imageProcessingStatus.filter(entry => entry.editingOverride);
        if (editingEntries.length > 0) {
          // Revert any unsaved changes
          editingEntries.forEach(entry => {
            // Store the original count before reverting
            const originalCount = entry.originalResults ? entry.originalResults.length : 0;
            
            // Exit editing mode
            entry.editingOverride = false;
            
            // If the count was changed from original, revert it
            if (entry.overriddenCount !== originalCount) {
              entry.overriddenCount = originalCount;
              // If the count is back to original, clear override status
              entry.overridden = false;
            }
          });
          updateReviewDataView();
        }
      });
    });

    // Also add a click event listener to the document to handle clicks outside the override input
    document.addEventListener('click', (e) => {
      // Check if the click was outside any override input
      if (!e.target.closest('.override-count-input') && !e.target.closest('.override-btn')) {
        // Find any entries that are in editing mode
        const editingEntries = imageProcessingStatus.filter(entry => entry.editingOverride);
        if (editingEntries.length > 0) {
          // Revert any unsaved changes
          editingEntries.forEach(entry => {
            // Store the original count before reverting
            const originalCount = entry.originalResults ? entry.originalResults.length : 0;
            
            // Exit editing mode
            entry.editingOverride = false;
            
            // If the count was changed from original, revert it
            if (entry.overriddenCount !== originalCount) {
              entry.overriddenCount = originalCount;
              // If the count is back to original, clear override status
              entry.overridden = false;
            }
          });
          updateReviewDataView();
        }
      }
    });

    // AI Results link
    const aiResultsLink = row.querySelector('.ai-results-link');
    if (aiResultsLink) {
      aiResultsLink.addEventListener('click', (e) => {
        e.preventDefault();
        alert(`Detailed AI Results for ${entry.file.name}:\n${JSON.stringify(entry.originalResults || entry.results, null, 2)}`);
      });
    }
    reviewTableBody.appendChild(row);
  });
  if (!anyRows) {
    const emptyRow = document.createElement('tr');
    emptyRow.innerHTML = `<td colspan="6" style="text-align:center; color:#b0b0b0;">No images to review. Please process images first.</td>`;
    reviewTableBody.appendChild(emptyRow);
  }
  // Select All logic
  const selectAllBox = document.getElementById('selectAllReview');
  const checkboxes = document.querySelectorAll('.review-select-checkbox');
  selectAllBox.checked = false; // Ensure it's unchecked initially
  selectAllBox.addEventListener('change', function() {
    checkboxes.forEach(cb => { cb.checked = selectAllBox.checked; });
    updateBatchButtonsState();
  });
  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateBatchButtonsState);
  });
  updateBatchButtonsState();
}

// --- Filtering and Search Event Listeners ---
document.querySelectorAll('.filter-tab-button').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-tab-button').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    updateReviewDataView();
  });
});
document.getElementById('reviewSearchInput').addEventListener('input', updateReviewDataView);

// --- Batch Action Buttons Logic ---
function getSelectedReviewIndexes() {
  return Array.from(document.querySelectorAll('.review-select-checkbox:checked')).map(cb => parseInt(cb.dataset.index));
}
function updateBatchButtonsState() {
  const selected = getSelectedReviewIndexes();
  const batchCard = document.getElementById('batchActionsCard');
  if (selected.length === 0) {
    document.getElementById('approveSelectedBtn').disabled = true;
    document.getElementById('rejectSelectedBtn').disabled = true;
    document.getElementById('overrideSelectedBtn').disabled = true;
    if (batchCard) batchCard.style.display = 'none';
  } else {
    document.getElementById('approveSelectedBtn').disabled = false;
    document.getElementById('rejectSelectedBtn').disabled = false;
    document.getElementById('overrideSelectedBtn').disabled = false;
    if (batchCard) batchCard.style.display = 'block';
  }
}
document.getElementById('approveSelectedBtn').addEventListener('click', () => {
  getSelectedReviewIndexes().forEach(idx => { imageProcessingStatus[idx].approved = true; imageProcessingStatus[idx].rejected = false; });
  updateReviewDataView();
});
document.getElementById('rejectSelectedBtn').addEventListener('click', () => {
  getSelectedReviewIndexes().forEach(idx => { imageProcessingStatus[idx].rejected = true; imageProcessingStatus[idx].approved = false; });
  updateReviewDataView();
});
document.getElementById('overrideSelectedBtn').addEventListener('click', () => {
  getSelectedReviewIndexes().forEach(idx => { alert(`Override ${imageProcessingStatus[idx].file.name}`); });
  updateReviewDataView();
});

// New function to update the model display in the Process Data tab
function updateModelDisplayInProcessTab() {
  currentModelProcessDataSpan.textContent = currentModelSpan.textContent;
}

// Add styles for image error state
const style = document.createElement('style');
style.textContent = `
.image-load-error {
  border: 2px solid #dc3545;
  padding: 5px;
  background-color: #f8d7da;
}

.selected-file-item.error {
  background-color: #f8d7da;
  border-color: #dc3545;
}

.error-message {
  color: #dc3545;
  font-size: 0.9em;
  margin-left: 10px;
}
`;
document.head.appendChild(style);

// Add favicon link
const faviconLink = document.createElement('link');
faviconLink.rel = 'icon';
faviconLink.type = 'image/x-icon';
faviconLink.href = '{% static "admindashboard/images/favicon.ico" %}';
document.head.appendChild(faviconLink);

// Add gallery navigation logic
let currentGalleryIndex = 0;
const galleryCard = document.getElementById('gallery-card');
const galleryControls = document.getElementById('gallery-controls');
const galleryPrevBtn = document.getElementById('gallery-prev');
const galleryNextBtn = document.getElementById('gallery-next');
const galleryCounter = document.getElementById('gallery-counter');

function updateGalleryNavigation() {
  if (!galleryCard) return;
  const total = imageProcessingStatus.length;
  if (total > 1) {
    galleryCard.style.display = 'block';
    galleryControls.style.display = 'flex';
    galleryPrevBtn.style.display = 'inline-block';
    galleryNextBtn.style.display = 'inline-block';
    galleryCounter.textContent = `${currentGalleryIndex + 1} of ${total}`;
    galleryPrevBtn.disabled = currentGalleryIndex === 0;
    galleryNextBtn.disabled = currentGalleryIndex === total - 1;
  } else if (total === 1) {
    galleryCard.style.display = 'block';
    galleryControls.style.display = 'none';
  } else {
    galleryCard.style.display = 'none';
  }
}

galleryPrevBtn.addEventListener('click', function() {
  if (currentGalleryIndex > 0) {
    currentGalleryIndex--;
    previewImageInGallery(imageProcessingStatus[currentGalleryIndex]);
    updateGalleryNavigation();
  }
});
galleryNextBtn.addEventListener('click', function() {
  if (currentGalleryIndex < imageProcessingStatus.length - 1) {
    currentGalleryIndex++;
    previewImageInGallery(imageProcessingStatus[currentGalleryIndex]);
    updateGalleryNavigation();
  }
});

// Add CSS for gallery card and navigation
const galleryStyle = document.createElement('style');
galleryStyle.textContent = `
.gallery-card {
  background: rgba(30, 34, 44, 0.7);
  border-radius: 16px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.25);
  padding: 24px 16px 16px 16px;
  margin-bottom: 24px;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
  transition: box-shadow 0.2s;
}
.gallery-controls {
  margin-bottom: 10px;
}
.gallery-nav-btn {
  background: rgba(74, 105, 189, 0.8);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 18px;
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}
.gallery-nav-btn:disabled {
  background: #3a3f44;
  color: #b0b0b0;
  cursor: not-allowed;
  opacity: 0.7;
}
.gallery-nav-btn:hover:not(:disabled) {
  background: #3e58a3;
  box-shadow: 0 4px 12px rgba(74,105,189,0.18);
  transform: translateY(-2px) scale(1.04);
}
.gallery-counter {
  color: #e0e0e0;
  font-size: 1.1em;
  font-weight: 500;
  letter-spacing: 1px;
}
`;
document.head.appendChild(galleryStyle);

// Add logic for the explicit process all button
const processAllImagesExplicitBtn = document.getElementById('processAllImagesExplicitBtn');
function updateProcessAllBtnState() {
  if (!processAllImagesExplicitBtn) return;
  // Enable if there are any Ready or Error images
  const hasReadyOrError = imageProcessingStatus.some(entry => entry.status === 'Ready' || entry.status === 'Error');
  processAllImagesExplicitBtn.disabled = !hasReadyOrError;
}
processAllImagesExplicitBtn.addEventListener('click', async function() {
  processAllImagesExplicitBtn.disabled = true;
  for (let i = 0; i < imageProcessingStatus.length; i++) {
    const entry = imageProcessingStatus[i];
    if (entry.status === 'Ready' || entry.status === 'Error') {
      await processSingleImage(i);
    }
  }
  processAllImagesExplicitBtn.disabled = false;
  updateProcessAllBtnState();

  // After batch processing, update the gallery for the first image if available
  if (imageProcessingStatus.length > 0) {
    previewImageInGallery(imageProcessingStatus[0]);
  }
});

// Add CSS for the process all button container
const processAllBtnStyle = document.createElement('style');
processAllBtnStyle.textContent = `
.process-data-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
  flex-wrap: wrap; /* Allow wrapping on smaller screens */
  gap: 15px; /* Space between filter group and button */
}

.filter-tabs {
  margin-bottom: 0; /* Remove default margin-bottom */
  display: flex; /* Ensure it's a flex container */
  flex-wrap: wrap;
  gap: 5px;
}

#processAllImagesExplicitBtn {
  font-size: 0.95em; /* Reduced font size for consistency */
  font-weight: 600;
  padding: 8px 20px; /* Adjusted padding to make it smaller */
  border-radius: 6px; /* Slightly more rounded for consistency */
  box-shadow: 0 1px 4px rgba(74,105,189,0.08); /* Reduced shadow for a lighter feel */
  transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
}
#processAllImagesExplicitBtn:disabled {
  background: #3a3f44;
  color: #b0b0b0;
  cursor: not-allowed;
  opacity: 0.7;
}
#processAllImagesExplicitBtn:hover:not(:disabled) {
  background: #3e58a3;
  box-shadow: 0 4px 12px rgba(74,105,189,0.18);
  transform: translateY(-2px) scale(1.04);
}
`;
document.head.appendChild(processAllBtnStyle);

// Add preview-only function for image preview in gallery or thumbnail clicks
function previewImageInGallery(fileEntry) {
  currentProcessedImage = fileEntry.file;
  currentProcessedImageDataUrl = null;
  currentGalleryIndex = imageProcessingStatus.indexOf(fileEntry);

  let overlay = document.getElementById('gallery-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'gallery-overlay';
    overlay.className = 'gallery-overlay';
    overlay.innerHTML = `<span class='gallery-overlay-text'><span class='spinner'></span> Not processed yet.</span>`;
    galleryCard.style.position = 'relative';
    galleryCard.appendChild(overlay);
  }

  // Find existing canvas or create new one
  let canvas = document.getElementById('processingCanvas');
  if (!canvas) { // If canvas does not exist, create it
    canvas = document.createElement('canvas');
    canvas.id = 'processingCanvas';
    gallery.appendChild(canvas); // Append only if new
  }

  const reader = new FileReader();
  reader.readAsDataURL(fileEntry.file);
  reader.onloadend = function() {
    currentProcessedImageDataUrl = reader.result;
    const img = new Image();
    img.src = currentProcessedImageDataUrl;
    img.onload = function() {
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.style.maxWidth = '100%';
      canvas.style.display = 'block';
      canvas.style.margin = '0 auto 10px';
      canvas.style.borderRadius = '10px';
      canvas.style.boxShadow = '0 2px 12px rgba(0,0,0,0.25)';
      canvas.style.opacity = '0';
      canvas.style.transition = 'opacity 0.3s';
      setTimeout(() => { canvas.style.opacity = '1'; }, 10);
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear existing content
      ctx.drawImage(img, 0, 0);
      // Draw detections if available
      if (fileEntry.status === 'Completed' && fileEntry.results && fileEntry.results.length > 0) {
        fileEntry.results.forEach(det => {
          let [x1, y1, x2, y2] = det.coordinates;
          ctx.lineWidth = 2;
          ctx.strokeStyle = 'red';
          ctx.font = "16px Arial";
          ctx.fillStyle = 'red';
          ctx.beginPath();
          ctx.rect(x1, y1, x2 - x1, y2 - y1);
          ctx.stroke();
          const label = `${det.class} (${(det.confidence * 100).toFixed(1)}%)`;
          ctx.fillText(label, x1, y1 > 15 ? y1 - 5 : y1 + 15);
        });
      }
      canvas.addEventListener('click', function() {
        modalImage.src = canvas.toDataURL();
        modal.style.display = 'block';
      });

      // Overlay visibility needs to be set after the image has loaded, in case status changed during load
      if (fileEntry.status === 'Processing') {
        overlay.innerHTML = `<span class='gallery-overlay-text'><span class='spinner'></span> Processing now...</span>`;
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
      } else {
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
      }
    };
  };

  // Update processed image preview details box immediately
  updateProcessedImagePreview(fileEntry);

  // Highlight the active thumbnail
  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('active-thumbnail');
  });
  const activeThumbnail = document.querySelector(`.thumbnail[data-index="${imageProcessingStatus.indexOf(fileEntry)}"]`);
  if (activeThumbnail) {
    activeThumbnail.classList.add('active-thumbnail');
  }
  updateGalleryNavigation();
}

// Refactor displayImageForProcessing to only process if not already processing or completed
async function displayImageForProcessing(fileEntry) {
  currentProcessedImage = fileEntry.file;
  currentProcessedImageDataUrl = null;
  currentGalleryIndex = imageProcessingStatus.indexOf(fileEntry);

  // Set the status to Processing and update the UI immediately via previewImageInGallery
  fileEntry.status = 'Processing';
  previewImageInGallery(fileEntry); // Call once to set processing state and preview

  await processSingleImage(currentGalleryIndex); // Perform the actual processing

  // After processing, preview again to show results/error
  previewImageInGallery(imageProcessingStatus[currentGalleryIndex]);
}

/* Modernized Review Controls and Table Styles */
const reviewModernStyle = document.createElement('style');
reviewModernStyle.textContent = `
.review-controls-container {
  background: rgba(44, 62, 80, 0.85);
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  padding: 18px 20px 12px 20px;
  margin-bottom: 24px;
  display: flex;
  flex-wrap: wrap;
  gap: 0 32px;
  align-items: flex-start;
  justify-content: flex-start;
  flex-direction: column;
}

.review-controls-container .filter-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 18px;
  background: transparent;
  padding: 0;
  box-shadow: none;
  border-radius: 0;
}

.review-controls-container input[type="text"] {
  background: #2c2f33;
  color: #e0e0e0;
  border: 1px solid #4a69bd;
  border-radius: 6px;
  padding: 8px 15px;
  font-size: 0.95em;
  outline: none;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.review-controls-container input[type="text"]:focus {
  border-color: #3e58a3;
  box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.4);
}

.review-batch-group-wrapper {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-top: 4px;
  margin-bottom: 2px;
}
.batch-actions-label {
  color: #b0b0b0;
  font-size: 0.98em;
  font-weight: 600;
  margin-bottom: 7px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-left: 2px;
}
.review-batch-group {
  display: flex;
  gap: 12px;
}
.review-batch-group .action-button {
  border-radius: 6px;
  font-size: 1em;
  font-weight: 600;
  padding: 9px 22px;
  margin-left: 0;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.review-batch-group .action-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
@media (min-width: 700px) {
  .review-controls-container {
    flex-direction: row;
    align-items: flex-end;
    gap: 18px 32px;
    justify-content: space-between;
  }
  .review-controls-container .filter-tabs {
    margin-bottom: 0;
  }
  .review-batch-group-wrapper {
    margin-top: 0;
    margin-bottom: 0;
    align-items: flex-end;
  }
}
.review-table-container {
  background: #23272a;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  padding: 0 0 18px 0;
  margin-bottom: 30px;
  overflow-x: auto;
}
.review-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  color: #e0e0e0;
  min-width: 800px;
}
.review-table th, .review-table td {
  padding: 14px 16px;
  text-align: left;
  border-bottom: 1px solid #3e444b;
  background: transparent;
}
.review-table th {
  background: #2c2f33;
  font-weight: 700;
  color: #b0b0b0;
  text-transform: uppercase;
  font-size: 0.98em;
  letter-spacing: 0.5px;
}
.review-table tbody tr:hover {
  background-color: #2f3338;
}
.review-table .action-button {
  min-width: 90px;
  margin-right: 6px;
  font-size: 0.98em;
  padding: 8px 0;
}
.review-table .approve-btn { background: #28a745; color: #fff; }
.review-table .approve-btn:hover { background: #218838; }
.review-table .reject-btn { background: #dc3545; color: #fff; }
.review-table .reject-btn:hover { background: #b52a37; }
.review-table .override-btn { background: #ffc107; color: #333; }
.review-table .override-btn:hover { background: #e0a800; color: #222; }
.review-table input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #4a69bd;
  border-radius: 4px;
  margin-right: 0;
}
@media (max-width: 700px) {
  .review-table, .review-table th, .review-table td {
    font-size: 0.95em;
    padding: 10px 6px;
  }
  .review-controls-container { padding: 8px 2px 6px 2px; }
}
`;
document.head.appendChild(reviewModernStyle);

/* Add CSS for the new batch actions card */
const batchActionsCardStyle = document.createElement('style');
batchActionsCardStyle.textContent = `
.batch-actions-card {
  background: rgba(44, 62, 80, 0.92);
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  padding: 18px 20px 12px 20px;
  margin-bottom: 24px;
  margin-top: 0;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
  transition: box-shadow 0.2s;
}
.batch-actions-label {
  color: #b0b0b0;
  font-size: 0.98em;
  font-weight: 600;
  margin-bottom: 7px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-left: 2px;
}
.review-batch-group {
  display: flex;
  gap: 12px;
}
.review-batch-group .action-button {
  border-radius: 6px;
  font-size: 1em;
  font-weight: 600;
  padding: 9px 22px;
  margin-left: 0;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.review-batch-group .action-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
`;
document.head.appendChild(batchActionsCardStyle);
</script>

<style>
/* General body and container styling */
body {
    background-color: #2c2f33; /* Dark background */
    color: #e0e0e0; /* Light text */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
}

.main-content-container {
    background: #23272a; /* Slightly lighter dark for content area */
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    margin: 40px auto;
    padding: 30px;
    max-width: 900px;
    border: 1px solid #36393f;
}

/* Tab Navigation */
.tab-navigation {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
    background: #2c2f33;
    border-radius: 8px;
  padding: 8px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.tab-button {
    background: transparent;
  border: none;
    color: #b0b0b0;
    padding: 12px 25px;
    font-size: 1.1em;
    font-weight: 600;
  cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    outline: none;
}

.tab-button:hover:not(.active) {
    color: #ffffff;
    background-color: #3e444b;
}

.tab-button.active {
    background-color: #4a69bd; /* A shade of blue */
    color: #ffffff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Content Panel */
.content-panel {
    background: #2c2f33;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    border: 1px solid #3e444b;
}

.panel-title {
    font-size: 2em;
    color: #ffffff;
    text-align: center;
    margin-bottom: 40px;
    letter-spacing: 1.5px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-title .icon-left {
    margin-right: 15px;
    font-size: 1.8em;
    color: #4a69bd;
}

/* Drop Zone Container */
.drop-zone-container {
    border: 2px dashed #4a69bd; /* Blue dashed border */
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background-color: #2f3338; /* Dark background */
    color: #e0e0e0; /* Light text */
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.drop-zone-container.highlight {
    background-color: #4e535a;
    border-color: #4a69bd;
    box-shadow: 0 0 15px rgba(74, 105, 189, 0.6);
}

.upload-icon {
    font-size: 4em;
    color: #4a69bd;
    margin-bottom: 20px;
    opacity: 0.8;
}

.drop-zone-text {
    font-size: 1.3em;
    color: #b0b0b0;
    margin-bottom: 10px;
}

.drop-zone-or {
    font-size: 1.1em;
    color: #888;
    margin-bottom: 20px;
    text-transform: uppercase;
}

/* Button Group for Select Files/Folder */
.button-group {
    display: flex;
    justify-content: center;
    gap: 20px;
}

.action-button {
    background-color: #4a69bd;
  color: white;
    padding: 15px 35px;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    font-weight: 600;
  cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    text-decoration: none; /* For label/a tag usage */
    display: inline-block; /* For label/a tag usage */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.action-button:hover {
    background-color: #3e58a3;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.action-button.secondary-button {
    background-color: #555;
    color: #e0e0e0;
}

.action-button.secondary-button:hover {
    background-color: #666;
}

.action-button:disabled {
    background-color: #3a3f44;
    cursor: not-allowed;
    opacity: 0.7;
    transform: none;
    box-shadow: none;
}

/* Bottom Action Buttons (Upload, Continue) */
.bottom-action-buttons {
  display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 40px;
}

/* Existing styles adaptations */
.dashboard-box {
    background: #36393f; /* Darker background for content boxes */
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    margin-bottom: 20px;
    border: 1px solid #4e535a;
}

#columns-container {
  display: flex;
    gap: 20px;
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
}

#columns-container .column {
    flex: 1;
    min-width: 300px; /* Minimum width before wrapping */
}

#gallery img, #previewCanvas {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

#result-box {
    min-height: 150px; /* Ensure some height for results */
    background: #2f3338;
  border-radius: 8px;
    padding: 15px;
    color: #e0e0e0;
    overflow-y: auto;
    max-height: 400px; /* Limit height for long results */
}

/* Model selection dropdown */
.model-select {
    padding: 8px 12px;
    border: 1px solid #4a69bd;
    border-radius: 6px;
    background: #36393f;
    color: #e0e0e0;
    appearance: none; /* Remove default dropdown arrow */
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.1%20146.2%20208.7%205.4%2069.1c-1.3-1.3-3.4-1.3-4.7%200s-1.3%203.4%200%204.7l141.6%20141.6c.7.7%201.5%201%202.3%201.3.8.3%201.6.3%202.4%200%201.3-.3%202.1-1%202.8-1.7L287%2073.8c1.3-1.3%201.3-3.4%200-4.7-1.4-1.3-3.5-1.3-4.7%200z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 10px top 50%;
    background-size: 12px;
    cursor: pointer;
}

/* Modal styles (adjust colors for dark theme) */
.modal {
  display: none; 
  position: fixed; 
  z-index: 1000; 
  left: 0;
  top: 0;
  width: 100%; 
  height: 100%; 
  overflow: auto; 
    background-color: rgba(0,0,0,0.8);
}

.modal-content {
    margin: 10% auto;
  display: block;
  max-width: 90%;
    max-height: 80vh;
}

#modalImage {
    width: auto;
  height: auto;
    max-width: 100%;
    max-height: 100%;
    display: block;
    margin: auto;
}

.modal-close {
  position: absolute;
  top: 20px;
  right: 35px;
    color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
    transition: 0.3s;
  cursor: pointer;
}

.modal-close:hover,
.modal-close:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}

/* Specific elements from original for proper display */
.container {
    padding: 0; /* Remove default container padding as main-content-container handles it */
}

.error-message {
    color: red; /* Basic red for error messages */
    font-weight: bold;
    padding: 10px;
    border: 1px solid red;
    background-color: rgba(255, 0, 0, 0.1);
    border-radius: 5px;
    margin-top: 10px;
}

/* Hide model info and error display as it's not in the target image layout, or integrate it differently */
/* For now, commenting out its display */
/*
.model-info-error-display {
    margin-bottom: 16px; padding: 10px; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 6px; color: #0050b3;
}
*/
.model-info-error-display {
    display: block; /* Make sure this is visible now */
    background: #2f3338; /* Darker background */
    border: 1px solid #4a69bd; /* Blue border */
    color: #e0e0e0; /* Light text */
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 20px; /* Add some space below it */
}

.model-info-error-display strong {
    color: #ffffff;
}

.model-select {
    margin-left: 10px;
    padding: 4px 8px;
    border: 1px solid #4a69bd;
    border-radius: 4px;
    background: #36393f;
    color: #e0e0e0;
}

.model-info-error-display div {
    margin-top: 10px;
    padding: 8px;
    background: #4a3838; /* Error background */
    border: 1px solid #cc4e4e; /* Error border */
    border-radius: 4px;
    color: #ff9e9e; /* Error text */
}

.process-gallery-thumbnails {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #4e535a;
    border-radius: 8px;
    background-color: #2f3338;
    min-height: 80px;
    align-items: center;
    justify-content: flex-start;
}

.process-gallery-thumbnails img {
    max-width: 80px; /* Adjust thumbnail size */
    max-height: 80px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s ease, border-color 0.2s ease;
}

.process-gallery-thumbnails img:hover {
    transform: translateY(-2px);
    border-color: #4a69bd;
}

.process-gallery-thumbnails img.active-thumbnail {
    border: 2px solid #4a69bd; /* Highlight active thumbnail */
    box-shadow: 0 0 8px rgba(74, 105, 189, 0.7);
}

.review-image-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #4e535a;
    border-radius: 8px;
    background-color: #2f3338;
}

.review-image-item img {
    margin-bottom: 10px;
}

/* Ensure the columns container itself doesn't have display: none from original code */
.columns-container {
    display: flex; /* Ensure it's flex by default, not hidden */
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 20px;
}

/* Adjust result-box for better display of detection text */
#result-box h4 {
    color: #ffffff;
    margin-top: 15px;
    margin-bottom: 10px;
    border-bottom: 1px solid #4e535a;
    padding-bottom: 5px;
}

#result-box ul {
    list-style-type: none;
    padding: 0;
}

#result-box li {
    margin-bottom: 5px;
    color: #b0b0b0;
}

#result-box p strong {
    color: #ffffff;
}

.temp-nav {
    display: none; /* Hide the temporary navigation button */
}

/* Adjustments for model selection for better integration */
.model-select-wrapper {
    margin-bottom: 20px; /* Adjust spacing */
    text-align: center;
}

/* If model select needs to be visible */
#currentModel {
    color: #e0e0e0;
    font-weight: 600;
}

/* Removed back button as per image layout */
.btn[onclick="showLoading(event)"] {
    display: none;
}

.upload-summary {
    color: #b0b0b0;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.1em;
}

.batch-progress-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    background: #2f3338;
    padding: 15px;
    border-radius: 10px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.progress-label {
    font-weight: 600;
    color: #e0e0e0;
    white-space: nowrap;
}

.progress-bar-background {
    flex-grow: 1;
    height: 12px;
    background-color: #3e444b;
    border-radius: 6px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background-color: #4a69bd; /* Blue progress */
    border-radius: 6px;
    transition: width 0.5s ease-in-out;
}

.progress-count {
    font-weight: 600;
    color: #e0e0e0;
    min-width: 40px; /* Ensure space for counts like 10/100 */
    text-align: right;
}

.filter-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    background: #2c2f33;
    border-radius: 8px;
    padding: 5px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.filter-tab-button {
    background: transparent;
    border: none;
    color: #b0b0b0;
    padding: 8px 15px;
    font-size: 0.95em;
    font-weight: 600;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    outline: none;
}

.filter-tab-button:hover:not(.active) {
    color: #ffffff;
    background-color: #3e444b;
}

.filter-tab-button.active {
    background-color: #4a69bd; /* Active blue */
    color: #ffffff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.image-processing-table-container {
    background: #2f3338;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    overflow-x: auto; /* Enable horizontal scrolling if table is too wide */
}

.image-processing-table {
    width: 100%;
    border-collapse: collapse;
    color: #e0e0e0;
}

.image-processing-table th,
.image-processing-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #4e535a;
}

.image-processing-table th {
    background-color: #3e444b;
    font-weight: 600;
    color: #ffffff;
    text-transform: uppercase;
    font-size: 0.9em;
}

.image-processing-table tbody tr:hover {
    background-color: #36393f; /* Hover effect for rows */
}

.thumbnail-table {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 5px;
    border: 1px solid #555;
    cursor: pointer;
}

.status-cell {
    font-weight: 600;
}

.status-ready {
    color: #6c757d; /* Grey */
}

.status-processing {
    color: #ffc107; /* Yellow */
}

.status-completed {
    color: #28a745; /* Green */
}

.status-error {
    color: #dc3545; /* Red */
}

.action-button.small-button {
    padding: 8px 15px;
    font-size: 0.9em;
    border-radius: 5px;
}

.review-instructions {
    color: #b0b0b0;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.1em;
}

.review-table-container {
    background: #2f3338;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    overflow-x: auto;
}

.review-table {
    width: 100%;
    border-collapse: collapse;
    color: #e0e0e0;
}

.review-table th,
.review-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #4e535a;
}

.review-table th {
    background-color: #3e444b;
    font-weight: 600;
    color: #ffffff;
    text-transform: uppercase;
    font-size: 0.9em;
}

.review-table tbody tr:hover {
    background-color: #36393f;
}

.review-table .action-button {
    margin-right: 5px;
    min-width: 80px;
}

.approve-btn {
    background-color: #28a745; /* Green */
    color: white;
}

.reject-btn {
    background-color: #dc3545; /* Red */
    color: white;
}

.override-btn {
    background-color: #ffc107; /* Yellow/Orange */
    color: #333;
}

.ai-results-link {
    color: #4a90e2; /* Blue link */
    text-decoration: none;
    font-weight: 600;
}

.ai-results-link:hover {
    text-decoration: underline;
}

/* New style for the disabled model display in Process Data tab */
.disabled-model-display {
    opacity: 0.6; /* Slightly grey out */
    pointer-events: none; /* Disable all interactions */
}

.disabled-model-display span {
    font-style: italic; /* Make the displayed model name look subtle */
    color: #b0b0b0; /* Lighter text color */
}

/* Add new CSS for selected-files-container */
.selected-files-container {
    background-color: #2f3338;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    min-height: 100px; /* Ensure it's visible even if empty */
    border: 1px solid #4e535a;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
    display: flex;
    flex-wrap: wrap; /* Allow items to wrap */
    gap: 15px; /* Space between file items */
    justify-content: flex-start; /* Align items to the start */
    align-items: center;
}

.no-files-selected-message {
    color: #b0b0b0;
    font-style: italic;
    width: 100%; /* Take full width to center text */
    text-align: center;
}

.selected-file-item {
    display: flex;
    align-items: center;
    background-color: #3e444b;
    border: 1px solid #4e535a;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    font-size: 0.9em;
    color: #e0e0e0;
}

.selected-file-thumbnail {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 10px;
    border: 1px solid #555;
}

.selected-file-name {
    flex-grow: 1;
    white-space: nowrap; /* Prevent text wrapping */
    overflow: hidden; /* Hide overflow text */
    text-overflow: ellipsis; /* Add ellipsis for overflow */
    max-width: 150px; /* Limit width of filename */
}

.remove-file-button {
    background: none;
    border: none;
    color: #ff6b6b; /* Red color for remove icon */
    font-size: 1.1em;
    margin-left: 10px;
    cursor: pointer;
    transition: color 0.2s ease;
}

.remove-file-button:hover {
    color: #ff3b3b;
}

/* Hide the original file preview and result containers in upload tab */
#columns-container {
    display: none; /* Ensure it's always hidden in the upload tab */
}

/* Add new styles for file validation and progress tracking */
.validation-rules {
  background: #2f3338;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid #4e535a;
}

.validation-rules h3 {
  color: #ffffff;
  margin-bottom: 10px;
  font-size: 1.1em;
}

.validation-rules ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.validation-rules li {
  color: #b0b0b0;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
}

.validation-rules li i {
  color: #4a69bd;
  margin-right: 10px;
}

.upload-progress-container {
  background: #2f3338;
  border-radius: 8px;
  padding: 20px;
  margin-top: 20px;
  border: 1px solid #4e535a;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.progress-header h3 {
  color: #ffffff;
  margin: 0;
  font-size: 1.1em;
}

#upload-status {
  color: #b0b0b0;
  font-size: 0.9em;
}

.progress-bar-container {
  background: #3e444b;
  border-radius: 4px;
  height: 20px;
  position: relative;
  margin-bottom: 20px;
}

.progress-bar {
  background: #4a69bd;
  border-radius: 4px;
  height: 100%;
  width: 0;
  transition: width 0.3s ease;
}

#upload-percentage {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #ffffff;
  font-size: 0.9em;
}

.file-progress-list {
  max-height: 200px;
  overflow-y: auto;
}

.file-progress-item {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  padding: 8px;
  background: #36393f;
  border-radius: 4px;
}

.file-name {
  flex: 1;
  color: #e0e0e0;
  font-size: 0.9em;
  margin-right: 10px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-progress-bar {
  flex: 2;
  background: #3e444b;
  border-radius: 4px;
  height: 10px;
  margin: 0 10px;
  overflow: hidden;
}

.file-progress-fill {
  background: #4a69bd;
  height: 100%;
  width: 0;
  transition: width 0.3s ease;
}

.file-progress-fill.error {
  background: #dc3545;
}

.file-progress-text {
  color: #b0b0b0;
  font-size: 0.8em;
  min-width: 40px;
  text-align: right;
}

.selected-file-size {
  color: #b0b0b0;
  font-size: 0.8em;
  margin-left: 10px;
}

.selected-file-item.error {
  background: #4a3838;
  border-color: #cc4e4e;
}

.selected-file-item.error .error-message {
  color: #ff9e9e;
  font-size: 0.8em;
  margin-left: 10px;
}

/* Add minimal CSS for new controls */
.review-controls-container { margin-bottom: 18px; }
.review-filter-btn { background: #36393f; color: #e0e0e0; border: none; border-radius: 5px; padding: 7px 18px; margin-right: 6px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
.review-filter-btn.active, .review-filter-btn:hover { background: #4a69bd; color: #fff; }
.review-batch-group .action-button { margin-left: 8px; }
.review-batch-group .action-button:disabled { opacity: 0.6; cursor: not-allowed; }
.review-filter-group input[type="text"] { background: #23272a; color: #e0e0e0; border: 1px solid #4a69bd; border-radius: 5px; }

/* New CSS for overridden states */
.status-overridden {
  color: #ffc107; /* Yellow/Orange for overridden status */
  font-weight: 600;
}

.status-overridden-editing {
  color: #4a90e2; /* Blue for active editing */
  font-weight: 600;
}

.overridden-row {
  background-color: #36393f; /* Slightly different background for overridden rows */
  border-left: 4px solid #ffc107; /* Left border highlight */
}

.override-count-input {
  background: #2c2f33;
  color: #e0e0e0;
  border: 1px solid #4a69bd;
  border-radius: 6px;
  padding: 5px 8px;
  font-size: 0.9em;
  width: 60px;
  text-align: center;
}

.override-count-input:focus {
  border-color: #3e58a3;
  box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.4);
  outline: none;
}
</style>
{% endblock %}
