{% extends "admindashboard/base.html" %}
{% load static %}

{% block content %}
<div class="main-content-container">
  <!-- Top Navigation Tabs -->
  <div class="tab-navigation">
    <button class="tab-button active" data-tab="upload">Upload</button>
    <button class="tab-button" data-tab="process-data">Process Data</button>
    <button class="tab-button" data-tab="review">Review</button>
  </div>

  <!-- Main Content Area -->
  <div id="upload-content" class="content-panel active-tab-content">
    <h2 class="panel-title">
      <i class="fas fa-cloud-upload-alt icon-left"></i> IMAGE UPLOAD & PROCESSING
    </h2>
    
    <!-- Model Info and Error Display - Moved from Process Data Tab -->
    <div class="model-info-error-display" style="margin-bottom: 16px; padding: 10px; background: #2f3338; border: 1px solid #4a69bd; border-radius: 6px; color: #e0e0e0;">
    <strong>Model in use:</strong>
    <span id="currentModel">Chinese Egret</span>
      <select id="modelSelect" class="model-select" style="margin-left: 10px; padding: 4px 8px; border: 1px solid #4a69bd; border-radius: 4px; background: #36393f; color: #e0e0e0;">
      <option value="chinese_egret">Chinese Egret</option>
      <option value="whiskered_tern">Whiskered Tern</option>
      <option value="great_knot">Great Knot</option>
    </select>
    {% if model_load_error %}
        <div class="error-message" style="margin-top: 10px; padding: 8px; background: #4a3838; border: 1px solid #cc4e4e; border-radius: 4px; color: #ff9e9e;">
        <strong>Error:</strong> {{ model_load_error }}
      </div>
    {% endif %}
  </div>
  
    <!-- Image Upload & Drop Zone -->
    <div class="drop-zone-container" id="drop-area">
      <div class="upload-icon">
        <i class="fas fa-cloud-upload-alt"></i>
      </div>
      <p class="drop-zone-text">Drag & drop images or folders here</p>
      <p class="drop-zone-or">or</p>
      <div class="button-group">
        <label for="fileElem" class="action-button primary-button">Select Files</label>
        <input type="file" id="fileElem" accept="image/*" multiple style="display: none;">
        <label for="folderElem" class="action-button secondary-button">Select Folder</label>
        <input type="file" id="folderElem" webkitdirectory mozdirectory msdirectory odirectory directory style="display: none;">
      </div>
  </div>
  
    <!-- Selected Files Display Area -->
    <div id="selected-files-display" class="selected-files-container">
      <p id="no-files-selected-message" class="no-files-selected-message">No files selected yet.</p>
      <!-- Selected files will be displayed here dynamically -->
  </div>
  
    <!-- Hidden file preview and result containers (initially hidden) -->
    <div id="columns-container" style="display: none;">
    <!-- Left Column: File Preview -->
    <div class="dashboard-box column" id="preview-container">
      <h3>File Preview:</h3>
      <div id="gallery"></div>
    </div>
    
    <!-- Right Column: Result -->
    <div class="dashboard-box column" id="result-container">
      <h3>Result:</h3>
      <div id="result-box">
        <!-- Processed result will be displayed here -->
      </div>
    </div>
  </div>
  
    <!-- Action Buttons at the Bottom -->
    <div class="bottom-action-buttons">
      <button id="uploadBtn" class="action-button primary-button">Upload</button>
  </div>
</div>

  <div id="process-data-content" class="content-panel" style="display: none;">
    <h2 class="panel-title">
      <i class="fas fa-cogs icon-left"></i> NEXT STEPS: REVIEW & PROCESS YOUR IMAGES
    </h2>
    <!-- Model Info and Error Display -->
    <div class="model-info-error-display disabled-model-display" style="margin-bottom: 16px; padding: 10px; background: #2f3338; border: 1px solid #4a69bd; border-radius: 6px; color: #e0e0e0;">
      <strong>Model in use:</strong>
      <span id="currentModelProcessData">Chinese Egret</span>
      {% if model_load_error %}
        <div class="error-message" style="margin-top: 10px; padding: 8px; background: #4a3838; border: 1px solid #cc4e4e; border-radius: 4px; color: #ff9e9e;">
          <strong>Error:</strong> {{ model_load_error }}
        </div>
      {% endif %}
    </div>
    <p class="upload-summary">You uploaded <span id="uploadedImageCount">0</span> images. All are ready for processing.</p>

    <div class="batch-progress-container">
      <span class="progress-label">Batch Progress:</span>
      <div class="progress-bar-background">
        <div class="progress-bar-fill" id="batchProgressBar" style="width: 0%;"></div>
      </div>
      <span class="progress-count" id="batchProgressCount">0/0</span>
    </div>

    <div class="filter-tabs">
      <button class="filter-tab-button active" data-filter="all">All</button>
      <button class="filter-tab-button" data-filter="processing">Processing</button>
      <button class="filter-tab-button" data-filter="completed">Completed</button>
      <button class="filter-tab-button" data-filter="error">Error</button>
    </div>

    <div class="image-processing-table-container">
      <table class="image-processing-table">
        <thead>
          <tr>
            <th>Thumbnail</th>
            <th>Filename</th>
            <th>Status</th>
            <th>AI Results</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="imageTableBody">
          <!-- Image rows will be dynamically inserted here -->
        </tbody>
      </table>
    </div>

    <div class="bottom-action-buttons">
        <button id="retryAllFailedBtn" class="action-button primary-button" style="display: none;">Retry All Failed</button>
        <button id="processAllImagesBtn" class="action-button primary-button">Process All Images</button>
    </div>
  </div>

  <div id="review-content" class="content-panel" style="display: none;">
    <h2 class="panel-title">
      <i class="fas fa-check-circle icon-left"></i> REVIEW DASHBOARD
    </h2>
    <p class="review-instructions">Review and approve or reject processed images below.</p>

    <div class="review-table-container">
      <table class="review-table">
        <thead>
          <tr>
            <th>Thumbnail</th>
            <th>Filename</th>
            <th>Status</th>
            <th>AI Results</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reviewTableBody">
          <!-- Review rows will be dynamically inserted here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal for full image preview -->
<div id="modal" class="modal">
  <span id="modalClose" class="modal-close">&times;</span>
  <div class="modal-content">
    <!-- The enlarged image will be inserted here -->
    <img id="modalImage" src="" alt="Full Image Preview">
  </div>
</div>

<script>
// DOM element references
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('fileElem');
const folderInput = document.getElementById('folderElem'); // New folder input
const gallery = document.getElementById('gallery');
const identifyBtn = document.getElementById('identifyBtn'); // Keep for now, will rename/repurpose
const resultBox = document.getElementById('result-box');
const modelSelect = document.getElementById('modelSelect');
const currentModelSpan = document.getElementById('currentModel');
const columnsContainer = document.getElementById('columns-container'); // New reference for columns container
const uploadBtn = document.getElementById('uploadBtn'); // New upload button
const continueBtn = document.getElementById('continueBtn'); // New continue button

// New: Tab elements
const tabButtons = document.querySelectorAll('.tab-button');
const uploadContent = document.getElementById('upload-content');
const processDataContent = document.getElementById('process-data-content');
const reviewContent = document.getElementById('review-content');
const processImagesBtn = document.getElementById('processImagesBtn');
const processGallery = document.getElementById('process-gallery');
const reviewResults = document.getElementById('review-results');
const uploadedImageCount = document.getElementById('uploadedImageCount'); // New element
const batchProgressBar = document.getElementById('batchProgressBar'); // New element
const batchProgressCount = document.getElementById('batchProgressCount'); // New element
const filterTabButtons = document.querySelectorAll('.filter-tab-button'); // New elements
const imageTableBody = document.getElementById('imageTableBody'); // New element
const retryAllFailedBtn = document.getElementById('retryAllFailedBtn'); // New element
const processAllImagesBtn = document.getElementById('processAllImagesBtn'); // New element
const reviewTableBody = document.getElementById('reviewTableBody'); // New element
const currentModelProcessDataSpan = document.getElementById('currentModelProcessData'); // New span for process data tab
const selectedFilesDisplay = document.getElementById('selected-files-display'); // New element
const noFilesSelectedMessage = document.getElementById('no-files-selected-message'); // New element

let currentImage = null;
let currentImageDataUrl = null;  // store the image data URL for redrawing on canvas
let selectedFiles = []; // New array to hold multiple files
let currentProcessedImage = null; // To store the currently displayed image in process tab
let currentProcessedImageDataUrl = null; // Data URL for redrawing

// Array to store processing status and results for each image
let imageProcessingStatus = [];

// Model selection change handler
modelSelect.addEventListener('change', function() {
  currentModelSpan.textContent = this.options[this.selectedIndex].text;
  // Clear previous results when model changes, but not necessarily table
  resultBox.innerHTML = '';
  // if (currentImage) { enableIdentify(); }
});

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
  document.body.addEventListener(eventName, preventDefaults, false);
});
function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

// Highlight drop area when file is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
});
['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
});

// Handle dropped files
dropArea.addEventListener('drop', handleDrop, false);
function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  handleFiles(files);
}

// Also handle files selected via the file input
fileInput.addEventListener('change', (e) => {
  handleFiles(e.target.files);
});

folderInput.addEventListener('change', (e) => {
  handleFiles(e.target.files);
});

function handleFiles(files) {
  console.log('handleFiles called with:', files); // DEBUG: Log files passed to function
  // Clear previous previews and results if needed
  gallery.innerHTML = '';
  resultBox.innerHTML = '';
  selectedFiles = []; // Clear previous selection
  imageProcessingStatus = []; // Clear previous processing status
  currentImage = null; // Clear single image reference
  currentImageDataUrl = null;

  selectedFilesDisplay.innerHTML = ''; // Clear current display

  if (files.length === 0) {
    noFilesSelectedMessage.style.display = 'block'; // Show message if no files
  } else {
    noFilesSelectedMessage.style.display = 'none'; // Hide message if files are selected
  }

  Array.from(files).forEach(file => {
    if (file.type.startsWith('image/')) {
      selectedFiles.push(file);
      const fileEntry = { file: file, status: 'Ready', results: null, error: null };
      imageProcessingStatus.push(fileEntry);

      const fileItem = document.createElement('div');
      fileItem.classList.add('selected-file-item');
      fileItem.dataset.index = imageProcessingStatus.indexOf(fileEntry); // Store index

      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onloadend = function() {
        fileEntry.dataUrl = reader.result; // Store data URL directly in entry
        const img = document.createElement('img');
        img.src = reader.result;
        img.classList.add('selected-file-thumbnail');
        fileItem.appendChild(img);
      };

      const fileNameSpan = document.createElement('span');
      fileNameSpan.textContent = file.name;
      fileNameSpan.classList.add('selected-file-name');
      fileItem.appendChild(fileNameSpan);

      const removeButton = document.createElement('button');
      removeButton.innerHTML = '<i class="fas fa-times"></i>'; // X icon
      removeButton.classList.add('remove-file-button');
      removeButton.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.closest('.selected-file-item').dataset.index);
        removeSelectedFile(indexToRemove);
      });
      fileItem.appendChild(removeButton);

      selectedFilesDisplay.appendChild(fileItem);
    }
  });
  
  console.log('selectedFiles after processing:', selectedFiles); // DEBUG: Log selectedFiles array
  if (selectedFiles.length > 0) {
    uploadBtn.disabled = false;
    console.log('Upload button enabled.'); // DEBUG: Log when upload button is enabled
  } else {
    uploadBtn.disabled = true;
    console.log('Upload button disabled (no files selected).'); // DEBUG: Log when upload button is disabled
  }
  updateProcessDataView(); // Update the process data view after files are handled
  updateModelDisplayInProcessTab(); // Update the model display in the process tab
}

// New function to remove a selected file
function removeSelectedFile(index) {
  // Remove from arrays
  selectedFiles.splice(index, 1);
  imageProcessingStatus.splice(index, 1);

  // Re-render the selected files display
  updateSelectedFilesDisplay();

  // Update upload button state
  if (selectedFiles.length > 0) {
    uploadBtn.disabled = false;
  } else {
    uploadBtn.disabled = true;
  }

  // Update process data view if needed (e.g., if files were removed from processing queue)
  updateProcessDataView();
  console.log(`File at index ${index} removed.`); // DEBUG
}

// New function to update the selected files display after changes (e.g., removal)
function updateSelectedFilesDisplay() {
  selectedFilesDisplay.innerHTML = ''; // Clear current display
  if (selectedFiles.length === 0) {
    noFilesSelectedMessage.style.display = 'block';
  } else {
    noFilesSelectedMessage.style.display = 'none';
    selectedFiles.forEach((file, index) => {
      const fileEntry = imageProcessingStatus.find(entry => entry.file === file); // Find corresponding entry
      if (!fileEntry) return; // Should not happen

      const fileItem = document.createElement('div');
      fileItem.classList.add('selected-file-item');
      fileItem.dataset.index = index; // Use new index after splice

      const img = document.createElement('img');
      img.src = fileEntry.dataUrl; // Use stored data URL
      img.classList.add('selected-file-thumbnail');
      fileItem.appendChild(img);

      const fileNameSpan = document.createElement('span');
      fileNameSpan.textContent = file.name;
      fileNameSpan.classList.add('selected-file-name');
      fileItem.appendChild(fileNameSpan);

      const removeButton = document.createElement('button');
      removeButton.innerHTML = '<i class="fas fa-times"></i>';
      removeButton.classList.add('remove-file-button');
      removeButton.addEventListener('click', (e) => {
        const indexToRemove = parseInt(e.currentTarget.closest('.selected-file-item').dataset.index);
        removeSelectedFile(indexToRemove);
      });
      fileItem.appendChild(removeButton);

      selectedFilesDisplay.appendChild(fileItem);
    });
  }
}

// Modify previewFile to not populate gallery in upload tab
function previewFile(file) {
  // This function will now only be called for the initial single preview in the upload tab if needed,
  // but primarily, the gallery in the process tab will use displayImageForProcessing.
  // For the upload tab, handleFiles populates the selected-files-display instead.
  // We can keep it to generate the dataUrl for the first file, which is then stored in imageProcessingStatus.
  const reader = new FileReader();
  reader.readAsDataURL(file);
  reader.onloadend = function() {
    currentImageDataUrl = reader.result;  // save the data URL for future use
    // No longer appending to 'gallery' in the upload tab here.
  }
}

// New function to display a specific image for processing in the large preview area
function displayImageForProcessing(fileEntry) {
  currentProcessedImage = fileEntry.file;
  currentProcessedImageDataUrl = null; // Clear previous data URL

  const reader = new FileReader();
  reader.readAsDataURL(fileEntry.file);
  reader.onloadend = function() {
    currentProcessedImageDataUrl = reader.result;

    gallery.innerHTML = ''; // Clear previous preview
    resultBox.innerHTML = ''; // Clear previous results

    const img = new Image();
    img.src = currentProcessedImageDataUrl;
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.id = 'processingCanvas'; // Unique ID for canvas in process tab
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.style.maxWidth = '100%';
      canvas.style.display = 'block';
      canvas.style.margin = '0 auto 10px';
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      
      canvas.addEventListener('click', function() {
        modalImage.src = canvas.toDataURL();
        modal.style.display = 'block';
      });
      
      gallery.appendChild(canvas);
      // processImagesBtn.disabled = false; // Enable process button when an image is selected
    };
  };

  // Highlight the active thumbnail
  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('active-thumbnail');
  });
  const activeThumbnail = document.querySelector(`.thumbnail[data-index="${imageProcessingStatus.indexOf(fileEntry)}"]`);
  if (activeThumbnail) {
    activeThumbnail.classList.add('active-thumbnail');
  }
}

function enableIdentify() {
  identifyBtn.disabled = false;
  identifyBtn.classList.remove('disabled');
}
function disableIdentify() {
  identifyBtn.disabled = true;
  identifyBtn.classList.add('disabled');
}

// Close modal when clicking on the close button or outside the image
modalClose.onclick = function() {
  modal.style.display = 'none';
}
window.onclick = function(e) {
  if (e.target == modal) {
    modal.style.display = 'none';
  }
}

// Upload button event (new functionality)
uploadBtn.addEventListener('click', async function() {
  if (selectedFiles.length === 0) {
    resultBox.innerHTML = `<p style=\'color:red;\'>Please select files to upload.</p>`;
    console.log('Upload button clicked but no files selected.'); // DEBUG: Log if no files on click
    return;
  }

  resultBox.innerHTML = '<p>Initiating image processing...</p>'; // Changed message
  uploadBtn.disabled = true; // Disable upload button during processing initiation

  showTab('process-data'); // Immediately switch to process data tab
  updateProcessDataView(); // Populate and update the table in the process data view

  // Trigger processing for all selected files
  for (let i = 0; i < imageProcessingStatus.length; i++) {
    const entry = imageProcessingStatus[i];
    if (entry.status === 'Ready') { // Only process if not already processed or errored
      await processSingleImage(i); // Process one by one to update UI
    }
  }
  uploadBtn.disabled = false; // Re-enable upload button after all processing is initiated
});

// Function to update the Process Data tab view
function updateProcessDataView() {
  uploadedImageCount.textContent = selectedFiles.length;
  batchProgressCount.textContent = `0/${selectedFiles.length}`;
  batchProgressBar.style.width = '0%';
  imageTableBody.innerHTML = ''; // Clear previous table content

  if (selectedFiles.length === 0) {
    imageTableBody.innerHTML = '<tr><td colspan="5">No images uploaded.</td></tr>';
    processAllImagesBtn.disabled = true;
    retryAllFailedBtn.style.display = 'none';
    return;
  }

  selectedFiles.forEach((file, index) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = function() {
      const row = imageTableBody.insertRow();
      row.dataset.index = index; // Store index for later reference
      row.innerHTML = `
        <td><img src="${reader.result}" class="thumbnail-table" alt="${file.name}"></td>
        <td>${file.name}</td>
        <td class="status-cell status-ready">Ready</td>
        <td>-</td>
        <td><button class="action-button small-button process-single-btn" data-index="${index}">Process</button></td>
      `;

      // Add click listener for thumbnail to display in large preview
      row.querySelector('.thumbnail-table').addEventListener('click', () => {
        displayImageForProcessing(imageProcessingStatus[index]);
      });

      // Add click listener for individual process button
      row.querySelector('.process-single-btn').addEventListener('click', async (e) => {
        const imageIndex = e.target.dataset.index;
        await processSingleImage(imageIndex);
      });

      // Automatically display the first image in the large preview when tab is opened
      if (index === 0) {
        displayImageForProcessing(imageProcessingStatus[index]);
      }
    };
  });
  processAllImagesBtn.disabled = false; // Enable process all button once table is populated
}

// Function to process a single image
async function processSingleImage(index) {
  const imageEntry = imageProcessingStatus[index];
  if (!imageEntry) return;

  // Update status in table
  const row = imageTableBody.querySelector(`tr[data-index="${index}"]`);
  if (row) {
    const statusCell = row.querySelector('.status-cell');
    statusCell.textContent = 'Processing';
    statusCell.classList.remove('status-ready', 'status-completed', 'status-error');
    statusCell.classList.add('status-processing');
    row.querySelector('td:nth-child(4)').textContent = '-'; // Clear AI Results
    row.querySelector('.process-single-btn').disabled = true; // Disable individual button
  }
  updateBatchProgress();

  const formData = new FormData();
  formData.append('image', imageEntry.file);
  formData.append('model', modelSelect.value);
  
  try {
    const response = await fetch('/admindashboard/api/process_bird_image/', {
    method: 'POST',
    body: formData,
    });
    const data = await response.json();

    if (data.error) {
      imageEntry.status = 'Error';
      imageEntry.error = data.error;
      if (row) {
        const statusCell = row.querySelector('.status-cell');
        statusCell.textContent = 'Error';
        statusCell.classList.remove('status-processing');
        statusCell.classList.add('status-error');
        row.querySelector('td:nth-child(4)').textContent = 'Failed';
        row.querySelector('.process-single-btn').disabled = false; // Re-enable for retry
        row.querySelector('.process-single-btn').textContent = 'Retry';
      }
    } else {
      imageEntry.status = 'Completed';
      imageEntry.results = data.detections; // Store detections
      if (row) {
        const statusCell = row.querySelector('.status-cell');
        statusCell.textContent = 'Completed';
        statusCell.classList.remove('status-processing');
        statusCell.classList.add('status-completed');
        row.querySelector('td:nth-child(4)').textContent = `${data.detections.length} detections`;
        row.querySelector('.process-single-btn').style.display = 'none'; // Hide button after completion
      }
    }
  } catch (error) {
    console.error(`Error processing ${imageEntry.file.name}:`, error);
    imageEntry.status = 'Error';
    imageEntry.error = error.message;
    if (row) {
      const statusCell = row.querySelector('.status-cell');
      statusCell.textContent = 'Error';
      statusCell.classList.remove('status-processing');
      statusCell.classList.add('status-error');
      row.querySelector('td:nth-child(4)').textContent = 'Error';
      row.querySelector('.process-single-btn').disabled = false;
      row.querySelector('.process-single-btn').textContent = 'Retry';
    }
  } finally {
    updateBatchProgress();
    checkAllProcessed();
    // If this was the currently displayed image in the large preview, update its result
    if (currentProcessedImage && currentProcessedImage.name === imageEntry.file.name) {
      updateProcessedImagePreview(imageEntry);
    }
  }
}

// Function to update batch progress
function updateBatchProgress() {
  const total = imageProcessingStatus.length;
  const completed = imageProcessingStatus.filter(item => item.status === 'Completed').length;
  const processing = imageProcessingStatus.filter(item => item.status === 'Processing').length;
  const error = imageProcessingStatus.filter(item => item.status === 'Error').length;

  batchProgressCount.textContent = `${completed}/${total}`;
  const progressPercentage = total > 0 ? (completed / total) * 100 : 0;
  batchProgressBar.style.width = `${progressPercentage}%`;

  // Show retry all failed button if there are errors
  if (error > 0) {
    retryAllFailedBtn.style.display = 'inline-block';
  } else {
    retryAllFailedBtn.style.display = 'none';
  }

  // Disable process all button if all are completed or processing
  if (completed + error === total || processing > 0) {
    processAllImagesBtn.disabled = true;
  } else {
    processAllImagesBtn.disabled = false;
  }

  // Update sub-tabs counts (optional, for later)
  document.querySelector(`.filter-tab-button[data-filter="all"]`).textContent = `All (${total})`;
  document.querySelector(`.filter-tab-button[data-filter="processing"]`).textContent = `Processing (${processing})`;
  document.querySelector(`.filter-tab-button[data-filter="completed"]`).textContent = `Completed (${completed})`;
  document.querySelector(`.filter-tab-button[data-filter="error"]`).textContent = `Error (${error})`;
}

// Function to check if all images are processed
function checkAllProcessed() {
  const total = imageProcessingStatus.length;
  const processedCount = imageProcessingStatus.filter(item => item.status === 'Completed' || item.status === 'Error').length;
  if (total > 0 && processedCount === total) {
    console.log('All images processed. You can now review the results.');
    // Potentially enable Review tab or prompt user to go to Review tab
    // For now, let's automatically switch to review tab when all are processed
    showTab('review');
    updateReviewDataView();
  }
}

// Function to update the large processed image preview
function updateProcessedImagePreview(imageEntry) {
  const canvas = document.getElementById('processingCanvas');
  if (canvas && imageEntry.status === 'Completed') {
        const ctx = canvas.getContext('2d');
        const img = new Image();
    img.src = imageEntry.dataUrl; // Assuming dataUrl is stored in imageEntry
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
      imageEntry.results.forEach(det => {
            let [x1, y1, x2, y2] = det.coordinates;
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'red';
            ctx.font = "16px Arial";
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.rect(x1, y1, x2 - x1, y2 - y1);
            ctx.stroke();
            const label = `${det.class} (${(det.confidence * 100).toFixed(1)}%)`;
            ctx.fillText(label, x1, y1 > 15 ? y1 - 5 : y1 + 15);
          });
    };
    // Update result box with details for the displayed image
    let detailHtml = '';
    if (imageEntry.results && imageEntry.results.length > 0) {
      const totalDetections = imageEntry.results.length;
      const sumConfidence = imageEntry.results.reduce((sum, det) => sum + det.confidence, 0);
      const avgConfidence = sumConfidence / totalDetections;

      const selectedModelName = modelSelect.options[modelSelect.selectedIndex].text;
      const scientificNames = {
        'Chinese Egret': 'Egretta eulophotes',
        'Whiskered Tern': 'Chlidonias hybrida',
        'Great Knot': 'Calidris tenuirostris'
      };

      detailHtml += `<p><strong>Total Detections:</strong> ${totalDetections}</p>`;
      detailHtml += `<p><strong>Species Type:</strong> ${selectedModelName}</p>`;
      detailHtml += `<p><strong>Scientific Name:</strong> <em>${scientificNames[selectedModelName] || 'N/A'}</em></p>`;
      detailHtml += `<p><strong>Average Confidence:</strong> ${(avgConfidence * 100).toFixed(2)}%</p>`;
      detailHtml += `<h4>Individual Detections:</h4><ul>`;
      imageEntry.results.forEach(det => {
        detailHtml += `<li>${det.class} (${(det.confidence * 100).toFixed(1)}%)</li>`;
      });
      detailHtml += `</ul>`;
    } else {
      detailHtml = `<p>No detections found for ${imageEntry.file.name}.</p>`;
    }
    resultBox.innerHTML = detailHtml;
  } else if (imageEntry.status === 'Error') {
    resultBox.innerHTML = `<p class="error-message"><strong>Error Processing:</strong> ${imageEntry.error}</p>`;
  } else {
    resultBox.innerHTML = '<p>Image not yet processed or no results available.</p>';
  }
}

// Process All Images button event
processAllImagesBtn.addEventListener('click', async function() {
  processAllImagesBtn.disabled = true;
  retryAllFailedBtn.disabled = true; // Disable retry button during batch processing

  for (let i = 0; i < imageProcessingStatus.length; i++) {
    const entry = imageProcessingStatus[i];
    // Only process if status is Ready or Error
    if (entry.status === 'Ready' || entry.status === 'Error') {
      await processSingleImage(i); // Process one by one to update UI
    }
  }
  processAllImagesBtn.disabled = false;
});

// Retry All Failed button event
retryAllFailedBtn.addEventListener('click', async function() {
  retryAllFailedBtn.disabled = true;
  processAllImagesBtn.disabled = true; // Disable process all during retry

  for (let i = 0; i < imageProcessingStatus.length; i++) {
    const entry = imageProcessingStatus[i];
    if (entry.status === 'Error') {
      await processSingleImage(i); // Retry only failed images
    }
  }
  retryAllFailedBtn.disabled = false;
  updateBatchProgress(); // Update progress and button states
});

// Filter tab buttons event listeners
filterTabButtons.forEach(button => {
  button.addEventListener('click', function() {
    filterTabButtons.forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    const filter = this.dataset.filter;
    filterImageTable(filter);
  });
});

// Function to filter the image table
function filterImageTable(filter) {
  const rows = imageTableBody.querySelectorAll('tr');
  rows.forEach(row => {
    const statusCell = row.querySelector('.status-cell');
    const status = statusCell.textContent.toLowerCase();
    
    if (filter === 'all') {
      row.style.display = '';
    } else if (status.includes(filter)) {
      row.style.display = '';
      } else {
      row.style.display = 'none';
    }
  });
}

// Tab switching logic
function showTab(tabName) {
  // Deactivate all tab buttons and hide all tab contents
  tabButtons.forEach(button => {
    button.classList.remove('active');
  });
  [uploadContent, processDataContent, reviewContent].forEach(content => {
    content.style.display = 'none';
  });

  // Activate the selected tab button and show its content
  const selectedTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
  const selectedTabContent = document.getElementById(`${tabName}-content`);

  if (selectedTabButton && selectedTabContent) {
    selectedTabButton.classList.add('active');
    selectedTabContent.style.display = 'block';
    if (tabName === 'review') {
      updateReviewDataView(); // Update review tab content when shown
    }
  }
}

// Add event listeners to tab buttons
tabButtons.forEach(button => {
  button.addEventListener('click', function() {
    const tabName = this.dataset.tab;
    showTab(tabName);
  });
});

// Initial state: hide columns container (handled by tab switching now)
// columnsContainer.style.display = 'none';

// Initial setup to show the Upload tab by default
showTab('upload');

// New function to update the Review tab view
function updateReviewDataView() {
  reviewTableBody.innerHTML = ''; // Clear previous table content

  if (imageProcessingStatus.length === 0) {
    reviewTableBody.innerHTML = '<tr><td colspan="5">No images to review. Please process images first.</td></tr>';
    return;
    }

  imageProcessingStatus.forEach((entry, index) => {
    const row = reviewTableBody.insertRow();
    row.dataset.index = index;
    let statusHtml = '';
    let aiResultsHtml = '';

    if (entry.status === 'Completed') {
      statusHtml = `<span class="status-cell status-completed"><i class="fas fa-check-circle"></i> Completed</span>`;
      if (entry.results && entry.results.length > 0) {
        const totalDetections = entry.results.length;
        const sumConfidence = entry.results.reduce((sum, det) => sum + det.confidence, 0);
        const avgConfidence = sumConfidence / totalDetections;
        aiResultsHtml = `<a href="#" class="ai-results-link" data-index="${index}">Birds: ${totalDetections}, Confidence: ${(avgConfidence * 100).toFixed(1)}%</a>`;
      } else {
        aiResultsHtml = 'No detections';
      }
    } else if (entry.status === 'Error') {
      statusHtml = `<span class="status-cell status-error"><i class="fas fa-times-circle"></i> Error</span>`;
      aiResultsHtml = `Processing failed: ${entry.error || 'Unknown error'}`;
    } else {
      statusHtml = `<span class="status-cell status-ready">${entry.status}</span>`;
      aiResultsHtml = 'N/A';
    }

    row.innerHTML = `
      <td><img src="${entry.dataUrl || ''}" class="thumbnail-table" alt="${entry.file.name}"></td>
      <td>${entry.file.name}</td>
      <td>${statusHtml}</td>
      <td>${aiResultsHtml}</td>
      <td>
        <button class="action-button small-button approve-btn" data-index="${index}">Approve</button>
        <button class="action-button small-button reject-btn" data-index="${index}">Reject</button>
        <button class="action-button small-button override-btn" data-index="${index}">Override</button>
      </td>
    `;
    // Store the dataUrl for the image entry for use in the review table
    const reader = new FileReader();
    reader.readAsDataURL(entry.file);
    reader.onloadend = function() {
      entry.dataUrl = reader.result;
      row.querySelector('.thumbnail-table').src = reader.result;
    };

    // Add event listeners for action buttons
    row.querySelector('.approve-btn').addEventListener('click', () => {
      alert(`Approved ${entry.file.name}`);
      // Implement actual approve logic (e.g., API call, update status)
    });
    row.querySelector('.reject-btn').addEventListener('click', () => {
      alert(`Rejected ${entry.file.name}`);
      // Implement actual reject logic
    });
    row.querySelector('.override-btn').addEventListener('click', () => {
      alert(`Override ${entry.file.name}`);
      // Implement actual override logic (e.g., open a modal for manual editing)
    });
    // Add click listener for AI Results link to show more details (optional)
    const aiResultsLink = row.querySelector('.ai-results-link');
    if (aiResultsLink) {
      aiResultsLink.addEventListener('click', (e) => {
        e.preventDefault();
        alert(`Detailed AI Results for ${entry.file.name}:\n${JSON.stringify(entry.results, null, 2)}`);
  });
    }
});
}

// New function to update the model display in the Process Data tab
function updateModelDisplayInProcessTab() {
  currentModelProcessDataSpan.textContent = currentModelSpan.textContent;
}
</script>

<style>
/* General body and container styling */
body {
    background-color: #2c2f33; /* Dark background */
    color: #e0e0e0; /* Light text */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
}

.main-content-container {
    background: #23272a; /* Slightly lighter dark for content area */
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    margin: 40px auto;
    padding: 30px;
    max-width: 900px;
    border: 1px solid #36393f;
}

/* Tab Navigation */
.tab-navigation {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
    background: #2c2f33;
    border-radius: 8px;
  padding: 8px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.tab-button {
    background: transparent;
  border: none;
    color: #b0b0b0;
    padding: 12px 25px;
    font-size: 1.1em;
    font-weight: 600;
  cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    outline: none;
}

.tab-button:hover:not(.active) {
    color: #ffffff;
    background-color: #3e444b;
}

.tab-button.active {
    background-color: #4a69bd; /* A shade of blue */
    color: #ffffff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Content Panel */
.content-panel {
    background: #2c2f33;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    border: 1px solid #3e444b;
}

.panel-title {
    font-size: 2em;
    color: #ffffff;
    text-align: center;
    margin-bottom: 40px;
    letter-spacing: 1.5px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-title .icon-left {
    margin-right: 15px;
    font-size: 1.8em;
    color: #4a69bd;
}

/* Drop Zone Container */
.drop-zone-container {
    border: 2px dashed #4a69bd; /* Blue dashed border */
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background-color: #2f3338; /* Dark background */
    color: #e0e0e0; /* Light text */
    transition: all 0.3s ease;
    margin-bottom: 20px;
}

.drop-zone-container.highlight {
    background-color: #4e535a;
    border-color: #4a69bd;
    box-shadow: 0 0 15px rgba(74, 105, 189, 0.6);
}

.upload-icon {
    font-size: 4em;
    color: #4a69bd;
    margin-bottom: 20px;
    opacity: 0.8;
}

.drop-zone-text {
    font-size: 1.3em;
    color: #b0b0b0;
    margin-bottom: 10px;
}

.drop-zone-or {
    font-size: 1.1em;
    color: #888;
    margin-bottom: 20px;
    text-transform: uppercase;
}

/* Button Group for Select Files/Folder */
.button-group {
    display: flex;
    justify-content: center;
    gap: 20px;
}

.action-button {
    background-color: #4a69bd;
  color: white;
    padding: 15px 35px;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    font-weight: 600;
  cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    text-decoration: none; /* For label/a tag usage */
    display: inline-block; /* For label/a tag usage */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.action-button:hover {
    background-color: #3e58a3;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.action-button.secondary-button {
    background-color: #555;
    color: #e0e0e0;
}

.action-button.secondary-button:hover {
    background-color: #666;
}

.action-button:disabled {
    background-color: #3a3f44;
    cursor: not-allowed;
    opacity: 0.7;
    transform: none;
    box-shadow: none;
}

/* Bottom Action Buttons (Upload, Continue) */
.bottom-action-buttons {
  display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 40px;
}

/* Existing styles adaptations */
.dashboard-box {
    background: #36393f; /* Darker background for content boxes */
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    margin-bottom: 20px;
    border: 1px solid #4e535a;
}

#columns-container {
  display: flex;
    gap: 20px;
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
}

#columns-container .column {
    flex: 1;
    min-width: 300px; /* Minimum width before wrapping */
}

#gallery img, #previewCanvas {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

#result-box {
    min-height: 150px; /* Ensure some height for results */
    background: #2f3338;
  border-radius: 8px;
    padding: 15px;
    color: #e0e0e0;
    overflow-y: auto;
    max-height: 400px; /* Limit height for long results */
}

/* Model selection dropdown */
.model-select {
    padding: 8px 12px;
    border: 1px solid #4a69bd;
    border-radius: 6px;
    background: #36393f;
    color: #e0e0e0;
    appearance: none; /* Remove default dropdown arrow */
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e0e0e0%22%20d%3D%22M287%2069.1%20146.2%20208.7%205.4%2069.1c-1.3-1.3-3.4-1.3-4.7%200s-1.3%203.4%200%204.7l141.6%20141.6c.7.7%201.5%201%202.3%201.3.8.3%201.6.3%202.4%200%201.3-.3%202.1-1%202.8-1.7L287%2073.8c1.3-1.3%201.3-3.4%200-4.7-1.4-1.3-3.5-1.3-4.7%200z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 10px top 50%;
    background-size: 12px;
    cursor: pointer;
}

/* Modal styles (adjust colors for dark theme) */
.modal {
  display: none; 
  position: fixed; 
  z-index: 1000; 
  left: 0;
  top: 0;
  width: 100%; 
  height: 100%; 
  overflow: auto; 
    background-color: rgba(0,0,0,0.8);
}

.modal-content {
    margin: 10% auto;
  display: block;
  max-width: 90%;
    max-height: 80vh;
}

#modalImage {
    width: auto;
  height: auto;
    max-width: 100%;
    max-height: 100%;
    display: block;
    margin: auto;
}

.modal-close {
  position: absolute;
  top: 20px;
  right: 35px;
    color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
    transition: 0.3s;
  cursor: pointer;
}

.modal-close:hover,
.modal-close:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}

/* Specific elements from original for proper display */
.container {
    padding: 0; /* Remove default container padding as main-content-container handles it */
}

.error-message {
    color: red; /* Basic red for error messages */
    font-weight: bold;
    padding: 10px;
    border: 1px solid red;
    background-color: rgba(255, 0, 0, 0.1);
    border-radius: 5px;
    margin-top: 10px;
}

/* Hide model info and error display as it's not in the target image layout, or integrate it differently */
/* For now, commenting out its display */
/*
.model-info-error-display {
    margin-bottom: 16px; padding: 10px; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 6px; color: #0050b3;
}
*/
.model-info-error-display {
    display: block; /* Make sure this is visible now */
    background: #2f3338; /* Darker background */
    border: 1px solid #4a69bd; /* Blue border */
    color: #e0e0e0; /* Light text */
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 20px; /* Add some space below it */
}

.model-info-error-display strong {
    color: #ffffff;
}

.model-select {
    margin-left: 10px;
    padding: 4px 8px;
    border: 1px solid #4a69bd;
    border-radius: 4px;
    background: #36393f;
    color: #e0e0e0;
}

.model-info-error-display div {
    margin-top: 10px;
    padding: 8px;
    background: #4a3838; /* Error background */
    border: 1px solid #cc4e4e; /* Error border */
    border-radius: 4px;
    color: #ff9e9e; /* Error text */
}

.process-gallery-thumbnails {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #4e535a;
    border-radius: 8px;
    background-color: #2f3338;
    min-height: 80px;
    align-items: center;
    justify-content: flex-start;
}

.process-gallery-thumbnails img {
    max-width: 80px; /* Adjust thumbnail size */
    max-height: 80px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s ease, border-color 0.2s ease;
}

.process-gallery-thumbnails img:hover {
    transform: translateY(-2px);
    border-color: #4a69bd;
}

.process-gallery-thumbnails img.active-thumbnail {
    border: 2px solid #4a69bd; /* Highlight active thumbnail */
    box-shadow: 0 0 8px rgba(74, 105, 189, 0.7);
}

.review-image-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #4e535a;
    border-radius: 8px;
    background-color: #2f3338;
}

.review-image-item img {
    margin-bottom: 10px;
}

/* Ensure the columns container itself doesn't have display: none from original code */
.columns-container {
    display: flex; /* Ensure it's flex by default, not hidden */
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 20px;
}

/* Adjust result-box for better display of detection text */
#result-box h4 {
    color: #ffffff;
    margin-top: 15px;
    margin-bottom: 10px;
    border-bottom: 1px solid #4e535a;
    padding-bottom: 5px;
}

#result-box ul {
    list-style-type: none;
    padding: 0;
}

#result-box li {
    margin-bottom: 5px;
    color: #b0b0b0;
}

#result-box p strong {
    color: #ffffff;
}

.temp-nav {
    display: none; /* Hide the temporary navigation button */
}

/* Adjustments for model selection for better integration */
.model-select-wrapper {
    margin-bottom: 20px; /* Adjust spacing */
    text-align: center;
}

/* If model select needs to be visible */
#currentModel {
    color: #e0e0e0;
    font-weight: 600;
}

/* Removed back button as per image layout */
.btn[onclick="showLoading(event)"] {
    display: none;
}

.upload-summary {
    color: #b0b0b0;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.1em;
}

.batch-progress-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    background: #2f3338;
    padding: 15px;
    border-radius: 10px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.progress-label {
    font-weight: 600;
    color: #e0e0e0;
    white-space: nowrap;
}

.progress-bar-background {
    flex-grow: 1;
    height: 12px;
    background-color: #3e444b;
    border-radius: 6px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background-color: #4a69bd; /* Blue progress */
    border-radius: 6px;
    transition: width 0.5s ease-in-out;
}

.progress-count {
    font-weight: 600;
    color: #e0e0e0;
    min-width: 40px; /* Ensure space for counts like 10/100 */
    text-align: right;
}

.filter-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    background: #2c2f33;
    border-radius: 8px;
    padding: 5px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
}

.filter-tab-button {
    background: transparent;
    border: none;
    color: #b0b0b0;
    padding: 8px 15px;
    font-size: 0.95em;
    font-weight: 600;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.3s ease;
    outline: none;
}

.filter-tab-button:hover:not(.active) {
    color: #ffffff;
    background-color: #3e444b;
}

.filter-tab-button.active {
    background-color: #4a69bd; /* Active blue */
    color: #ffffff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.image-processing-table-container {
    background: #2f3338;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    overflow-x: auto; /* Enable horizontal scrolling if table is too wide */
}

.image-processing-table {
    width: 100%;
    border-collapse: collapse;
    color: #e0e0e0;
}

.image-processing-table th,
.image-processing-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #4e535a;
}

.image-processing-table th {
    background-color: #3e444b;
    font-weight: 600;
    color: #ffffff;
    text-transform: uppercase;
    font-size: 0.9em;
}

.image-processing-table tbody tr:hover {
    background-color: #36393f; /* Hover effect for rows */
}

.thumbnail-table {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 5px;
    border: 1px solid #555;
    cursor: pointer;
}

.status-cell {
    font-weight: 600;
}

.status-ready {
    color: #6c757d; /* Grey */
}

.status-processing {
    color: #ffc107; /* Yellow */
}

.status-completed {
    color: #28a745; /* Green */
}

.status-error {
    color: #dc3545; /* Red */
}

.action-button.small-button {
    padding: 8px 15px;
    font-size: 0.9em;
    border-radius: 5px;
}

.review-instructions {
    color: #b0b0b0;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.1em;
}

.review-table-container {
    background: #2f3338;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    overflow-x: auto;
}

.review-table {
    width: 100%;
    border-collapse: collapse;
    color: #e0e0e0;
}

.review-table th,
.review-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #4e535a;
}

.review-table th {
    background-color: #3e444b;
    font-weight: 600;
    color: #ffffff;
    text-transform: uppercase;
    font-size: 0.9em;
}

.review-table tbody tr:hover {
    background-color: #36393f;
}

.review-table .action-button {
    margin-right: 5px;
    min-width: 80px;
}

.approve-btn {
    background-color: #28a745; /* Green */
    color: white;
}

.reject-btn {
    background-color: #dc3545; /* Red */
    color: white;
}

.override-btn {
    background-color: #ffc107; /* Yellow/Orange */
    color: #333;
}

.ai-results-link {
    color: #4a90e2; /* Blue link */
    text-decoration: none;
    font-weight: 600;
}

.ai-results-link:hover {
    text-decoration: underline;
}

/* New style for the disabled model display in Process Data tab */
.disabled-model-display {
    opacity: 0.6; /* Slightly grey out */
    pointer-events: none; /* Disable all interactions */
}

.disabled-model-display span {
    font-style: italic; /* Make the displayed model name look subtle */
    color: #b0b0b0; /* Lighter text color */
}

/* Add new CSS for selected-files-container */
.selected-files-container {
    background-color: #2f3338;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    min-height: 100px; /* Ensure it's visible even if empty */
    border: 1px solid #4e535a;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
    display: flex;
    flex-wrap: wrap; /* Allow items to wrap */
    gap: 15px; /* Space between file items */
    justify-content: flex-start; /* Align items to the start */
    align-items: center;
}

.no-files-selected-message {
    color: #b0b0b0;
    font-style: italic;
    width: 100%; /* Take full width to center text */
    text-align: center;
}

.selected-file-item {
    display: flex;
    align-items: center;
    background-color: #3e444b;
    border: 1px solid #4e535a;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    font-size: 0.9em;
    color: #e0e0e0;
}

.selected-file-thumbnail {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 10px;
    border: 1px solid #555;
}

.selected-file-name {
    flex-grow: 1;
    white-space: nowrap; /* Prevent text wrapping */
    overflow: hidden; /* Hide overflow text */
    text-overflow: ellipsis; /* Add ellipsis for overflow */
    max-width: 150px; /* Limit width of filename */
}

.remove-file-button {
    background: none;
    border: none;
    color: #ff6b6b; /* Red color for remove icon */
    font-size: 1.1em;
    margin-left: 10px;
    cursor: pointer;
    transition: color 0.2s ease;
}

.remove-file-button:hover {
    color: #ff3b3b;
}

/* Hide the original file preview and result containers in upload tab */
#columns-container {
    display: none; /* Ensure it's always hidden in the upload tab */
}
</style>
{% endblock %}
